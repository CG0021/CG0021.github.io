<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเปรียบเทียบประสิทธิภาพ TPS</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'IBM Plex Sans Thai', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 95vh;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            gap: 20px;
        }

        .header-title {
            display: flex;
            flex-direction: column;
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 600;
            margin: 0;
        }
        
        .search-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .province-box {
            position: relative;
            width: 250px;
            display: flex;
            gap: 5px;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-family: 'IBM Plex Sans Thai', sans-serif;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        input[type="text"]:focus {
            outline: none;
            background: white;
            color: #2c3e50;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
        }

        input[type="text"]:focus::placeholder {
            color: #999;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-family: 'IBM Plex Sans Thai', sans-serif;
            white-space: nowrap;
            transition: background 0.3s;
        }

        .btn-add-all {
            background: #27ae60;
        }
        .btn-add-all:hover {
            background: #2ecc71;
        }
        .btn-analyze {
            background: #e67e22;
        }
        .btn-analyze:hover {
            background: #f39c12;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            color: white;
            text-decoration: none;
            border-radius: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            transition: background-color 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.2);
            white-space: nowrap;
        }

        .nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .nav-btn.active {
            background-color: #2980b9;
            font-weight: 600;
            cursor: default;
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 5px;
            color: #2c3e50;
        }

        .suggestion-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .suggestion-item:hover {
            background: #f8f9fa;
        }

        .table-wrapper {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            min-width: 800px;
        }

        th,
        td {
            z-index: 1;
            font-weight: 500;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            height: 60px;
            user-select: none;
        }

        /* Draggable Header Styling */
        thead th.draggable {
            cursor: grab;
        }

        thead th.draggable:active {
            cursor: grabbing;
        }

        thead th.dragging {
            opacity: 0.5;
            background: #34495e;
        }

        /* First Column Sticky */
        th:first-child,
        td:first-child {
            position: sticky;
            left: 0;
            background: white;
            z-index: 30;
            border-right: 2px solid #bdc3c7;
            min-width: 350px;
            max-width: 350px;
            text-align: left;
        }

        /* Make Table Header Sticky */
        thead th {
            position: sticky;
            top: 0;
            background: #2c3e50;
            color: white;
            z-index: 50;
        }

        thead th:first-child {
            z-index: 60; /* Higher z-index for the top-left corner */
        }

        /* Hospital Columns */
        th:not(:first-child):not(:nth-child(2)),
        td:not(:first-child):not(:nth-child(2)) {
            min-width: 150px;
            max-width: 150px;
        }

        /* Row Styles */
        tr:hover td {
            background-color: #f1f8ff;
        }

        .section-header td {
            background-color: #e9ecef;
            font-weight: 600;
            color: #2c3e50;
        }

        .sub-header td {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .score-cell {
            text-align: center;
            font-weight: 500;
            position: relative;
            cursor: help;
        }

        .score-cell.zero {
            color: #e74c3c;
            font-weight: bold;
        }

        .full-score {
            text-align: center;
            color: #7f8c8d;
            background: #fafafa;
            width: 80px;
            min-width: 80px;
        }

        /* Tooltip */
        .custom-tooltip {
            visibility: hidden;
            position: absolute;
            background-color: #333;
            color: #fff;
            text-align: left;
            padding: 10px;
            border-radius: 6px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9em;
            width: 250px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            pointer-events: none;
            white-space: normal;
        }

        .score-cell:hover .custom-tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Positioning tooltip */
        .score-cell .custom-tooltip {
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 10px;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            border-bottom: 1px solid #555;
            padding-bottom: 2px;
        }

        .tooltip-row:last-child {
            border-bottom: none;
        }

        .tooltip-label {
            color: #aaa;
        }

        .tooltip-val {
            font-weight: bold;
            color: #fff;
        }

        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.8em;
            cursor: pointer;
            margin-top: 5px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .spinner-small {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        /* Report Modal */
        .report-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .report-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #888;
            width: 80%;
            max-width: 1200px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        
        .report-header {
            padding: 15px 25px;
            background: #34495e;
            color: white;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .report-close-btn:hover,
        .report-close-btn:focus {
            color: #fff;
        }

        .report-body {
            padding: 20px 25px;
            overflow-y: auto;
        }
        
        @keyframes fadeIn {
            from {opacity: 0}
            to {opacity: 1}
        }

        .report-section {
            margin-bottom: 25px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .report-section-title {
            background: #e9ecef;
            padding: 10px 15px;
            font-weight: 600;
            border-bottom: 1px solid #ddd;
        }
        .report-section-body {
            padding: 15px;
        }
        .report-summary {
            font-weight: 500;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .report-summary.pass { color: #27ae60; }
        .report-summary.fail { color: #e74c3c; }
        .report-summary.mixed { color: #f39c12; }

        .report-ranking {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .rank-list h4 {
            font-weight: 600;
            margin-bottom: 8px;
            border-bottom: 2px solid;
            padding-bottom: 4px;
        }
        .rank-list.best h4 { border-color: #27ae60; }
        .rank-list.worst h4 { border-color: #e74c3c; }
        .rank-list ol {
            list-style-position: inside;
            padding-left: 5px;
        }
        .rank-list li {
            padding: 4px 0;
            display: flex;
            justify-content: space-between;
        }
        .rank-list .value {
            font-weight: 500;
        }
        .report-group-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #2c3e50;
            margin-top: 20px;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-title">
                <h1>ระบบเปรียบเทียบประสิทธิภาพ TPS</h1>
                <div class="header-subtitle">เปรียบเทียบข้อมูลหลายโรงพยาบาล</div>
            </div>

            <div class="nav-buttons">
                <a href="https://cg0021.github.io/TPS.html" class="nav-btn">ระบบวิเคราะห์ TPS</a>
            </div>

            <div class="search-group">
                <div class="province-box">
                    <input type="text" id="provinceInput" placeholder="ระบุจังหวัด">
                    <div class="suggestions" id="provinceSuggestions"></div>
                    <button class="btn btn-add-all" onclick="addAllByProvince()">เพิ่มทั้งจังหวัด</button>
                </div>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ค้นหาและเพิ่มโรงพยาบาล..." disabled>
                    <div class="suggestions" id="suggestions"></div>
                </div>
                 <button class="btn btn-analyze" onclick="generateComparisonReport()">วิเคราะห์เปรียบเทียบ</button>
            </div>
        </div>

        <div class="table-wrapper">
            <table id="compareTable">
                <thead>
                    <tr id="headerRow">
                        <th>รายการ</th>
                        <th>เต็ม</th>
                        <!-- Dynamic Hospital Headers -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Dynamic Rows -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="loading" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p style="margin-top: 10px; color: #3498db; font-weight: 500;">กำลังโหลดข้อมูล...</p>
    </div>
    
    <div id="reportModal" class="report-modal">
        <div class="report-modal-content">
            <div class="report-header">
                <h2>ผลการวิเคราะห์เปรียบเทียบ</h2>
                <span class="report-close-btn" onclick="closeReport()">&times;</span>
            </div>
            <div id="reportBody" class="report-body">
                <!-- Report content will be injected here -->
            </div>
        </div>
    </div>


    <script>
        // State
        let hospitalList = [];
        let selectedHospitals = []; // Array of { code, name, data }
        let draggedColIndex = null;

        // Configuration for Rows
        const rowConfig = [
            { id: 'grade', label: 'TPS Grade', type: 'summary', key: 'TPS Grade' },
            { id: 'total', label: 'รวมคะแนนประเมินประสิทธิภาพ', full: 15.0, type: 'summary', key: 'คะแนนประเมินประสิทธิภาพ' },

            { id: '1', label: '1. ตัวชี้วัดกระบวนการ (Process Indicators)', type: 'section' },

            { id: '1.1', label: '1.1 การบริหารแผนทางการเงิน', full: 2.0, type: 'header', key: 'คะแนน 1.1' },
            { id: '1.1.1', label: '1.1.1 มิติรายได้ ± ไม่เกิน 5 %', full: 1.0, type: 'item', key: 'P_รายได้', resultKey: 'รวมรายได้_ร้อยละ', unit: '%' },
            { id: '1.1.2', label: '1.1.2 มิติค่าใช้จ่าย ± ไม่เกิน 5 %', full: 1.0, type: 'item', key: 'P_ค่าใช้จ่าย', resultKey: 'รวมค่าใช้จ่าย_ร้อยละ', unit: '%' },

            { id: '1.2', label: '1.2 การบริหารสินทรัพย์หมุนเวียนและหนี้สินหมุนเวียน', full: 3.0, type: 'header', key: 'คะแนน1.2' },
            { id: '1.2.1', label: '1.2.1 ระยะเวลาชำระเจ้าหนี้การค้า (App-D)', full: 1.0, type: 'item', key: 'P_App-D', resultKey: 'App-D', unit: 'วัน' },
            { id: '1.2.2', label: '1.2.2 ระยะเวลาเก็บหนี้ UC (ACP:UC)', full: 0.5, type: 'item', key: 'P_acp uc', resultKey: 'ACP:UC', unit: 'วัน' },
            { id: '1.2.3', label: '1.2.3 ระยะเวลาเก็บหนี้ CS (ACP:CS)', full: 0.5, type: 'item', key: 'P_acp cs', resultKey: 'ACP:CS', unit: 'วัน' },
            { id: '1.2.4', label: '1.2.4 การบริหารสินค้าคงคลัง (AIP)', full: 1.0, type: 'item', key: 'P_Aip', resultKey: 'AIP', unit: 'วัน' },

            { id: '1.3', label: '1.3 การบริหารจัดการ', full: 5.0, type: 'header', calcSum: ['1.3.1', '1.3.2', '1.3.3'] },

            { id: '1.3.1', label: '1.3.1 การบริหารต้นทุนและค่าใช้จ่าย', full: 2.0, type: 'sub-header', key: 'คะแนน 1.3.1' },
            {
                id: '1.3.1.1', label: '1.3.1.1 Unit Cost for OP', full: 1.0, type: 'item', key: 'QM-OP',
                sheet: 'qm', resultKey: 'ต้นทุนบริการผู้ป่วยนอกต่อครั้ง', meanKey: 'Mean+1SD(ผู้ป่วยนอก)', unit: 'บาท'
            },
            {
                id: '1.3.1.2', label: '1.3.1.2 Unit Cost for IP', full: 1.0, type: 'item', key: 'QM-IP',
                sheet: 'qm', resultKey: 'ต้นทุนบริการผู้ป่วยในต่อ AdjRW', meanKey: 'Mean+1SD(ผู้ป่วยใน)', unit: 'บาท'
            },
            {
                id: '1.3.1.3', label: '1.3.1.3 LC ค่าแรงบุคลากร', full: 0.5, type: 'item', key: 'LC',
                sheet: 'hgr', resultKey: 'LC', meanKey: 'Mean#LC', diffKey: 'ผลต่างLC', unit: 'บาท'
            },
            {
                id: '1.3.1.4', label: '1.3.1.4 MC ค่ายา', full: 0.5, type: 'item', key: 'ค่ายา',
                sheet: 'hgr', resultKey: 'ค่ายา', meanKey: 'Mean#ค่ายา', diffKey: 'ผลต่างค่ายา', unit: 'บาท'
            },
            {
                id: '1.3.1.5', label: '1.3.1.5 MC วัสดุวิทย์ฯ', full: 0.5, type: 'item', key: 'ค่าวัสดุวิทยาศาสตร์และการแพทย์',
                sheet: 'hgr', resultKey: 'ค่าวัสดุวิทยาศาสตร์และการแพทย์', meanKey: 'Mean#ค่าวัสดุวิทยาศาสตร์และการแพทย์', diffKey: 'ผลต่างค่าวัสดุวิทยาศาสตร์และการแพทย์', unit: 'บาท'
            },
            {
                id: '1.3.1.6', label: '1.3.1.6 MC เวชภัณฑ์มิใช่ยาฯ', full: 0.5, type: 'item', key: 'ค่าเวชภัณฑ์มิใช่ยาและวัสดุการแพทย์',
                sheet: 'hgr', resultKey: 'ค่าเวชภัณฑ์มิใช่ยาและวัสดุการแพทย์', meanKey: 'Mean#ค่าเวชภัณฑ์มิใช่ยาและวัสดุการแพทย์', diffKey: 'ผลต่างค่าเวชภัณฑ์มิใช่ยาและวัสดุการแพทย์', unit: 'บาท'
            },

            { id: '1.3.2', label: '1.3.2 ตรวจสอบงบทดลองเบื้องต้น', full: 1.0, type: 'item', key: '1.3.2 ตรวจสอบงบทดลอง' },

            { id: '1.3.3', label: '1.3.3 ผลผลิต (Productivity)', full: 2.0, type: 'sub-header', key: 'คะแนน 1.3.3' },
            {
                id: '1.3.3.1', label: '1.3.3.1 อัตราครองเตียง', full: 1.0, type: 'item', key: 'อัตราครองเตียง',
                sheet: 'occupancy', resultKey: '%อัตราครองเตียง', unit: '%'
            },
            {
                id: '1.3.3.2', label: '1.3.3.2 SumAdjRW', full: 1.0, type: 'item', key: 'Sum AdjRW',
                sheet: 'occupancy', resultKey: '2568Q4', meanKey: 'ค่ากลางกลุ่ม', diffKey: 'ผลเปรียบเทียบค่ากลางกลุ่ม'
            },

            { id: '2', label: '2. ตัวชี้วัดผลลัพท์การดำเนินงาน', full: 5.0, type: 'section', key: 'คะแนน 2 ตัวชี้วัดผลการดำเนินงาน' },

            { id: '2.1', label: '2.1 ความสามารถในการทำกำไร', full: 3.0, type: 'header', key: 'คะแนน 2.1' },
            {
                id: '2.1.1', label: '2.1.1 Operating Margin', full: 1.0, type: 'item', key: 'OPM',
                sheet: 'ratio', resultKey: 'Ratio_OPM', meanKey: 'Ratio_OPMค่ากลาง', unit: '%'
            },
            {
                id: '2.1.2', label: '2.1.2 Return on Asset (ROA)', full: 1.0, type: 'item', key: 'ROA',
                sheet: 'ratio', resultKey: 'Ratio_ROA', meanKey: 'Ratio_ROAค่ากลาง', unit: '%'
            },
            { id: '2.1.3', label: '2.1.3 EBITDA', full: 1.0, type: 'item', key: 'EBITDA_Score', resultKey: 'EBITDA', unit: 'บาท' },

            { id: '2.2', label: '2.2 สภาพคล่องทางการเงิน', full: 2.0, type: 'header', key: 'คะแนน 2.2' },
            { id: '2.2.1', label: '2.2.1 Net Working Capital (NWC)', full: 1.0, type: 'item', key: 'P_NWC', resultKey: 'ทุนสำรองสุทธิ(NWC)', unit: 'บาท' },
            {
                id: '2.2.2', label: '2.2.2 Cash Ratio', full: 1.0, type: 'item', key: 'Cash',
                sheet: 'ratio', resultKey: 'Cash R', unit: 'เท่า'
            }
        ];

        // --- Helper Functions ---
        function showLoading() { document.getElementById('loading').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loading').style.display = 'none'; }

        function formatNumber(num, fractionDigits = 2) {
            if (num === null || num === undefined || num === '') return '-';
            let parsedNum = typeof num === 'string' ? parseFloat(num.replace(/,/g, '')) : num;
            if (isNaN(parsedNum)) return '-';
            return new Intl.NumberFormat('th-TH', { minimumFractionDigits: fractionDigits, maximumFractionDigits: fractionDigits }).format(parsedNum);
        }

        function isZero(val) {
            if (val === null || val === undefined || val === '') return false;
            const num = parseFloat(val);
            return !isNaN(num) && num === 0;
        }

        function getValue(row, headers, columnName) {
            if (!row || !headers) return null;
            const index = headers.findIndex(h => h && h.toString().includes(columnName));
            return index !== -1 ? row[index] : null;
        }

        function findHospitalInSheet(sheetData, hospitalCode) {
            if (!sheetData || !Array.isArray(sheetData) || sheetData.length < 2) return null;
            const codeIndex = sheetData[0].findIndex(h => h && h.toString().includes('รหัส'));
            if (codeIndex === -1) return null;

            for (let i = 1; i < sheetData.length; i++) {
                if (sheetData[i][codeIndex] == hospitalCode) {
                    return { headers: sheetData[0], row: sheetData[i] };
                }
            }
            return null;
        }

        // --- Data Fetching ---
        async function fetchHospitalList() {
            return new Promise((resolve, reject) => {
                showLoading();
                const callbackName = 'cb_list_' + Date.now();
                window[callbackName] = (data) => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    hideLoading();
                    if (data.error) reject(data.message);
                    else resolve(data.list || []);
                };
                const script = document.createElement('script');
                script.src = `https://script.google.com/macros/s/AKfycbyO26iU11w8EnwnWIz3d1S5uEYmBbUrzIgK3PXooMajmblDAppEuPAqsykGN7XY8uFB/exec?action=list&callback=${callbackName}`;
                script.onerror = () => { hideLoading(); reject('Load failed'); };
                document.body.appendChild(script);
            });
        }

        async function fetchHospitalDetails(code) {
            return new Promise((resolve, reject) => {
                const callbackName = 'cb_data_' + Date.now();
                window[callbackName] = (data) => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    if (data.error) reject(data.message);
                    else resolve(data);
                };
                const script = document.createElement('script');
                script.src = `https://script.google.com/macros/s/AKfycbyO26iU11w8EnwnWIz3d1S5uEYmBbUrzIgK3PXooMajmblDAppEuPAqsykGN7XY8uFB/exec?action=data&code=${code}&callback=${callbackName}`;
                script.onerror = () => {
                    reject('Load failed');
                };
                document.body.appendChild(script);
            });
        }

        async function fetchHospitalDetailsWithRetry(code, retries = 3, timeout = 15000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const result = await Promise.race([
                        fetchHospitalDetails(code),
                        new Promise((_, reject) =>
                            setTimeout(() => reject(new Error('Timeout')), timeout)
                        )
                    ]);
                    return result; 
                } catch (error) {
                    console.warn(`Attempt ${i + 1}/${retries} failed for hospital ${code}:`, error.message);
                    if (i === retries - 1) {
                        throw new Error(`Failed to load data for hospital ${code} after ${retries} attempts.`);
                    }
                    await new Promise(res => setTimeout(res, 500));
                }
            }
        }

        // --- Core Logic ---

        function getCellData(hospital, config) {
            if (!hospital || !hospital.data || !hospital.data.main) return { score: null, result: null, mean: null, diff: null };

            const mainHeaders = hospital.data.main[0];
            const mainRow = hospital.data.main[1];
            const code = getValue(mainRow, mainHeaders, 'รหัส');

            let score = 0;
            let result = null;
            let mean = null;
            let diff = null;

            if (config.calcSum) {
                let sum = 0;
                config.calcSum.forEach(childId => {
                    const childRow = rowConfig.find(r => r.id === childId);
                    if (childRow && childRow.key) {
                        const val = getValue(mainRow, mainHeaders, childRow.key);
                        sum += parseFloat(val || 0);
                    }
                });
                score = sum.toFixed(1);
            } else if (config.key) {
                score = getValue(mainRow, mainHeaders, config.key);
            }

            let targetSheet = null;
            if (config.sheet) {
                if (config.sheet === 'qm') targetSheet = hospital.data.qm;
                if (config.sheet === 'hgr') targetSheet = hospital.data.hgr;
                if (config.sheet === 'occupancy') targetSheet = hospital.data.occupancy;
                if (config.sheet === 'ratio') targetSheet = hospital.data.ratio;

                const sheetData = findHospitalInSheet(targetSheet, code);
                if (sheetData) {
                    if (config.resultKey) result = getValue(sheetData.row, sheetData.headers, config.resultKey);
                    if (config.meanKey) mean = getValue(sheetData.row, sheetData.headers, config.meanKey);
                    if (config.diffKey) diff = getValue(sheetData.row, sheetData.headers, config.diffKey);
                }
            } else {
                if (config.resultKey) {
                    result = getValue(mainRow, mainHeaders, config.resultKey);
                }
            }
            
            const parseToFloat = (val) => {
                 if (val === null || val === undefined || val === '') return null;
                 if (typeof val === 'string') val = val.replace(/,/g, '');
                 const num = parseFloat(val);
                 return isNaN(num) ? null : num;
            };

            return { 
                score: parseToFloat(score), 
                result: parseToFloat(result), 
                mean: parseToFloat(mean), 
                diff: parseToFloat(diff), 
                unit: config.unit 
            };
        }

        function renderTable() {
            const theadRow = document.getElementById('headerRow');
            const tbody = document.getElementById('tableBody');

            while (theadRow.children.length > 2) {
                theadRow.removeChild(theadRow.lastChild);
            }

            selectedHospitals.forEach((h, index) => {
                const th = document.createElement('th');
                let headerContent = '';
                if (h.loading) {
                    headerContent = `
                        <div style="display:flex; flex-direction:column; align-items:center; gap:5px;">
                            <div class="spinner-small"></div>
                            <span style="font-size:1.1em; color:#7f8c8d;">${h.name || 'กำลังโหลด...'}</span>
                            <button class="remove-btn" onclick="removeHospital(${index})">ลบ</button>
                        </div>
                    `;
                } else {
                    headerContent = `
                        <div style="display:flex; flex-direction:column; align-items:center;">
                            <span style="font-size:1.1em;">${h.name}</span>
                            <button class="remove-btn" onclick="removeHospital(${index})">ลบ</button>
                        </div>
                    `;
                }

                th.innerHTML = headerContent;
                th.style.minWidth = '120px';

                if (!h.loading) {
                    th.draggable = true;
                    th.classList.add('draggable');
                    th.dataset.index = index;
                    th.addEventListener('dragstart', handleDragStart);
                    th.addEventListener('dragover', handleDragOver);
                    th.addEventListener('drop', handleDrop);
                    th.addEventListener('dragend', handleDragEnd);
                }

                theadRow.appendChild(th);
            });

            tbody.innerHTML = '';
            rowConfig.forEach(row => {
                const tr = document.createElement('tr');
                if (row.type === 'section') tr.className = 'section-header';
                else if (row.type === 'header') tr.className = 'sub-header';

                const tdName = document.createElement('td');
                tdName.style.paddingLeft = row.id.split('.').length > 2 ? (row.id.split('.').length * 10 + 'px') : '15px';
                tdName.textContent = row.label;
                tr.appendChild(tdName);

                const tdFull = document.createElement('td');
                tdFull.className = 'full-score';
                tdFull.textContent = row.full !== undefined ? row.full.toFixed(1) : '';
                tr.appendChild(tdFull);

                selectedHospitals.forEach(h => {
                    const td = document.createElement('td');
                    td.className = 'score-cell';

                    if (h.loading) {
                        td.innerHTML = '<div class="spinner-small"></div>';
                    } else if (h.data && !h.data.error) {
                        if (row.type === 'section') {
                            if (row.key) {
                                const data = getCellData(h, row);
                                td.textContent = data.score !== null ? formatNumber(data.score, 1) : '';
                            }
                        } else {
                            const data = getCellData(h, row);
                            td.textContent = data.score !== null ? formatNumber(data.score, 1) : '0.0';
                            if (isZero(data.score)) td.classList.add('zero');

                            if (data.result !== null || data.mean !== null || data.diff !== null) {
                                const tooltip = document.createElement('div');
                                tooltip.className = 'custom-tooltip';
                                let html = `<div style="font-weight:bold; margin-bottom:5px; border-bottom:1px solid #777; padding-bottom:3px;">${row.label}</div>`;
                                if (data.result !== null) html += `<div class="tooltip-row"><span class="tooltip-label">ผลลัพธ์:</span> <span class="tooltip-val">${formatNumber(data.result)} ${data.unit || ''}</span></div>`;
                                if (data.mean !== null) html += `<div class="tooltip-row"><span class="tooltip-label">ค่ากลาง:</span> <span class="tooltip-val">${formatNumber(data.mean)}</span></div>`;
                                if (data.diff !== null) html += `<div class="tooltip-row"><span class="tooltip-label">ผลต่าง:</span> <span class="tooltip-val">${formatNumber(data.diff)}</span></div>`;
                                tooltip.innerHTML = html;
                                td.appendChild(tooltip);
                            }
                        }
                    } else {
                        td.innerHTML = '<span style="color: #e74c3c;">Error</span>';
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        // --- Drag and Drop Handlers ---
        function handleDragStart(e) {
            draggedColIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            const targetIndex = parseInt(this.dataset.index);
            if (draggedColIndex !== null && draggedColIndex !== targetIndex) {
                const item = selectedHospitals.splice(draggedColIndex, 1)[0];
                selectedHospitals.splice(targetIndex, 0, item);
                renderTable();
            }
            return false;
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
            draggedColIndex = null;
        }

        // --- Hospital Management ---
        async function addHospital(code, knownName = '') {
            // Prevent adding duplicates
            if (selectedHospitals.some(h => h.code === code)) {
                return;
            }

            const placeholder = { code, name: knownName || code, loading: true, data: null };
            selectedHospitals.push(placeholder);
            renderTable();

            try {
                const data = await fetchHospitalDetailsWithRetry(code);
                const target = selectedHospitals.find(h => h.code === code);

                // Check for valid data, if not, treat as an error
                if (!data.main || data.main.length < 2) {
                    throw new Error('Incomplete data received');
                }

                if (target) {
                    const name = getValue(data.main[1], data.main[0], 'โรงพยาบาล');
                    target.name = name || knownName;
                    target.data = data;
                    target.loading = false;
                    renderTable();
                    document.getElementById('searchInput').value = '';
                }
            } catch (e) {
                console.error(`Removing hospital ${code} due to load failure: ${e.message}`);
                // Find and remove the hospital from the array
                const index = selectedHospitals.findIndex(h => h.code === code);
                if (index > -1) {
                    selectedHospitals.splice(index, 1);
                }
                // Re-render the table to reflect the removal
                renderTable();
            }
        }

        async function addAllByProvince() {
            const province = document.getElementById('provinceInput').value.trim();
            if (!province) return;

            const matches = hospitalList.filter(h => h.p && h.p.toString().includes(province));
            if (matches.length === 0) {
                 alert('ไม่พบโรงพยาบาลในจังหวัดที่ระบุ');
                 return;
            }
            if (matches.length > 20 && !confirm(`พบ ${matches.length} โรงพยาบาล การโหลดอาจใช้เวลานาน ยืนยันหรือไม่?`)) return;

            matches.forEach(h => addHospital(h.c, h.n));
        }

        function removeHospital(index) {
            selectedHospitals.splice(index, 1);
            renderTable();
        }

        // --- Report Generation ---
        const reportIndicators = [
            { group: '1. ตัวชี้วัดกระบวนการ (Process Indicators)' },
            { subgroup: '1.1 การบริหารแผนทางการเงินเปรียบเทียบผลการดำเนินงานผลต่าง' },
            {
                title: '1.1.1 มิติรายได้ ± ไม่เกิน 5 %', rowId: '1.1.1',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: '%',
                sortBest: (a, b) => Math.abs(a.value) - Math.abs(b.value),
                sortWorst: (a, b) => Math.abs(b.value) - Math.abs(a.value),
            },
            {
                title: '1.1.2 มิติค่าใช้จ่าย ± ไม่เกิน 5 %', rowId: '1.1.2',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: '%',
                sortBest: (a, b) => Math.abs(a.value) - Math.abs(b.value),
                sortWorst: (a, b) => Math.abs(b.value) - Math.abs(a.value),
            },
            { subgroup: '1.2 การบริหารสินทรัพย์หมุนเวียนและหนี้สินหมุนเวียน' },
            {
                title: '1.2.1 ระยะเวลาชำระเจ้าหนี้การค้ายา&เวชภัณฑ์มิใช่ยา ≤ 90 วัน', rowId: '1.2.1', // Note: 180 day rule not implemented
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: 'วัน',
                sortBest: (a, b) => a.value - b.value,
                sortWorst: (a, b) => b.value - a.value,
            },
            {
                title: '1.2.2 ระยะเวลาถัวเฉลี่ยในการเรียกเก็บหนี้สิทธิ UC ≤60 วัน', rowId: '1.2.2',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: 'วัน',
                sortBest: (a, b) => a.value - b.value,
                sortWorst: (a, b) => b.value - a.value,
            },
            {
                title: '1.2.3 ระยะเวลาถัวเฉลี่ยในการเรียกเก็บหนี้สิทธิข้าราชการ ≤60 วัน', rowId: '1.2.3',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: 'วัน',
                sortBest: (a, b) => a.value - b.value,
                sortWorst: (a, b) => b.value - a.value,
            },
            {
                title: '1.2.4 การบริหารสินคงคลัง (Inventory Management) ≤ 60 วัน', rowId: '1.2.4', // Note: Island rule not implemented
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: 'วัน',
                sortBest: (a, b) => a.value - b.value,
                sortWorst: (a, b) => b.value - a.value,
            },
            { subgroup: '1.3 การบริหารจัดการ' },
            {
                title: '1.3.1.1 Unit Cost for OP', rowId: '1.3.1.1',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: 'บาท',
                sortBest: (a, b) => a.value - b.value, // Lower is better
                sortWorst: (a, b) => b.value - a.value,
            },
            {
                title: '1.3.1.2 Unit Cost for IP', rowId: '1.3.1.2',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: 'บาท',
                sortBest: (a, b) => a.value - b.value,
                sortWorst: (a, b) => b.value - a.value,
            },
            {
                title: '1.3.1.3 LC ค่าแรงบุคลากร', rowId: '1.3.1.3',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: 'บาท',
                sortBest: (a, b) => a.value - b.value,
                sortWorst: (a, b) => b.value - a.value,
            },
            {
                title: '1.3.1.4 MC ค่ายา', rowId: '1.3.1.4',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: 'บาท',
                sortBest: (a, b) => a.value - b.value,
                sortWorst: (a, b) => b.value - a.value,
            },
            {
                title: '1.3.1.5 MC ค่าวัสดุวิทยาศาสตร์และการแพทย์', rowId: '1.3.1.5',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: 'บาท',
                sortBest: (a, b) => a.value - b.value,
                sortWorst: (a, b) => b.value - a.value,
            },
            {
                title: '1.3.1.6 MC ค่าเวชภัณฑ์มิใช่ยาและวัสดุการแพทย์', rowId: '1.3.1.6',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: 'บาท',
                sortBest: (a, b) => a.value - b.value,
                sortWorst: (a, b) => b.value - a.value,
            },
            {
                title: '1.3.2 คะแนนตรวจสอบงบทดลองเบื้องต้น', rowId: '1.3.2',
                type: 'fail_only',
                passFn: (d) => d.score > 0,
            },
            {
                title: '1.3.3.1 อัตราครองเตียงผู้ป่วยใน ≥ 80 %', rowId: '1.3.3.1',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: '%',
                sortBest: (a, b) => b.value - a.value, // Higher is better
                sortWorst: (a, b) => a.value - b.value,
            },
            {
                title: '1.3.3.2 SumAdjRW เกินค่ากลางกลุ่มรพ.', rowId: '1.3.3.2',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result,
                sortBest: (a, b) => b.value - a.value, // Higher is better
                sortWorst: (a, b) => a.value - b.value,
            },
            { group: '2. ตัวชี้วัดผลลัพท์การดำเนินงาน' },
            { subgroup: '2.1 ความสามารถในการทำกำไร' },
            {
                title: '2.1.1 ประสิทธิภาพในการดำเนินงาน (Operating Margin)', rowId: '2.1.1',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: '%',
                sortBest: (a, b) => b.value - a.value,
                sortWorst: (a, b) => a.value - b.value,
            },
            {
                title: '2.1.2 อัตราผลตอบแทนจากสินทรัพย์ (Return on Asset)', rowId: '2.1.2',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: '%',
                sortBest: (a, b) => b.value - a.value,
                sortWorst: (a, b) => a.value - b.value,
            },
            {
                title: '2.1.3 ผลกำไรขาดทุนก่อนหักค่าเสื่อม (EBITDA) ≥ 0', rowId: '2.1.3',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: 'บาท',
                sortBest: (a, b) => b.value - a.value,
                sortWorst: (a, b) => a.value - b.value,
            },
            { subgroup: '2.2 การวัดสภาพคล่องทางการเงิน' },
            {
                title: '2.2.1 ทุนสำรองสุทธิ (Net Working Capital) ≥ 0', rowId: '2.2.1',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: 'บาท',
                sortBest: (a, b) => b.value - a.value,
                sortWorst: (a, b) => a.value - b.value,
            },
            {
                title: '2.2.2 Cash Ratio ≥ 0.8', rowId: '2.2.2',
                passFn: (d) => d.score > 0,
                valueSelector: (d) => d.result, unit: 'เท่า',
                sortBest: (a, b) => b.value - a.value,
                sortWorst: (a, b) => a.value - b.value,
            },
        ];

        function generateComparisonReport() {
            const modal = document.getElementById('reportModal');
            const reportBody = document.getElementById('reportBody');
            reportBody.innerHTML = ''; // Clear previous report

            const hospitals = selectedHospitals.filter(h => !h.loading && h.data && !h.data.error);

            if (hospitals.length < 1) {
                reportBody.innerHTML = '<p style="text-align:center; padding: 20px;">กรุณาเลือกและรอโหลดข้อมูลโรงพยาบาลอย่างน้อย 1 แห่ง</p>';
                modal.style.display = 'block';
                return;
            }

            let html = '';
            reportIndicators.forEach(indicator => {
                if (indicator.group) {
                    html += `<h2 class="report-group-title">${indicator.group}</h2>`;
                    return;
                }
                if (indicator.subgroup) {
                    html += `<h3 class="report-group-title" style="font-size:1.2em; margin-top:15px; margin-bottom:10px;">${indicator.subgroup}</h3>`;
                    return;
                }

                html += `<div class="report-section">`;
                html += `<div class="report-section-title">${indicator.title}</div>`;
                html += `<div class="report-section-body">`;

                const hospitalData = hospitals.map(h => {
                    const config = rowConfig.find(r => r.id === indicator.rowId);
                    const data = getCellData(h, config);
                    return {
                        name: h.name,
                        data: data,
                        value: indicator.valueSelector ? indicator.valueSelector(data) : data.score,
                    };
                }).filter(h => h.value !== null && h.value !== undefined);

                const passed = hospitalData.filter(h => indicator.passFn(h.data));
                const failed = hospitalData.filter(h => !indicator.passFn(h.data));

                // Summary
                let summaryClass = 'mixed';
                let summaryText = '';
                if (failed.length === 0 && passed.length > 0) {
                    summaryClass = 'pass';
                    summaryText = 'ทุกโรงพยาบาลผ่านตัวชี้วัดนี้';
                } else if (passed.length === 0 && failed.length > 0) {
                    summaryClass = 'fail';
                    summaryText = 'ทุกโรงพยาบาลไม่ผ่านตัวชี้วัดนี้';
                } else if (passed.length > 0 && failed.length > 0) {

                    summaryText = `มี <strong style="color:#27ae60">ผ่าน</strong>  <strong style="color:#27ae60">${passed.length}</strong> โรงพยาบาล และ <strong style="color:#e74c3c">ไม่ผ่าน</strong> <strong style="color:#e74c3c">${failed.length}</strong> โรงพยาบาล ในตัวชี้วัดนี้`;
              
                
                
                } else {
                    summaryText = 'ไม่พบข้อมูลสำหรับตัวชี้วัดนี้';
                }
                html += `<div class="report-summary ${summaryClass}">${summaryText}</div>`;

                if (indicator.type === 'fail_only') {
                     if(failed.length > 0) {
                        html += '<div class="rank-list worst"><h4>โรงพยาบาลที่ไม่ผ่าน</h4><ol>';
                        failed.forEach(h => {
                            html += `<li><span>${h.name}</span></li>`;
                        });
                        html += '</ol></div>';
                    }
                } else {
                    html += '<div class="report-ranking">';
                    // Best 
                    if (passed.length > 0) {
                        passed.sort(indicator.sortBest);
                        html += '<div class="rank-list best"><h4>โรงพยาบาลที่ผ่าน (เรียงตามผลงานดีที่สุด)</h4><ol>';
                        passed.forEach(h => {
                            html += `<li><span>${h.name}</span> <span class="value">${formatNumber(h.value)} ${indicator.unit || ''}</span></li>`;
                        });
                        html += '</ol></div>';
                    } else {
                        html += '<div class="rank-list best"><h4>โรงพยาบาลที่ผ่าน</h4><p>-</p></div>';
                    }

                    // Worst
                    if (failed.length > 0) {
                        failed.sort(indicator.sortWorst);
                        html += '<div class="rank-list worst"><h4>โรงพยาบาลที่ไม่ผ่าน (เรียงตามผลงานที่ต้องปรับปรุง)</h4><ol>';
                        failed.forEach(h => {
                             html += `<li><span>${h.name}</span> <span class="value">${formatNumber(h.value)} ${indicator.unit || ''}</span></li>`;
                        });
                        html += '</ol></div>';
                    } else {
                         html += '<div class="rank-list worst"><h4>โรงพยาบาลที่ไม่ผ่าน</h4><p>-</p></div>';
                    }
                    html += '</div>'; // end report-ranking
                }

                html += `</div></div>`; // end report-section-body and report-section
            });

            reportBody.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeReport() {
            document.getElementById('reportModal').style.display = 'none';
        }

        // --- Initialization ---
        window.onload = async () => {
            try {
                hospitalList = await fetchHospitalList();
                const searchInput = document.getElementById('searchInput');
                searchInput.disabled = false;

                // Search Logic
                searchInput.addEventListener('input', (e) => {
                    const val = e.target.value.toLowerCase();
                    const suggestions = document.getElementById('suggestions');
                    if (val.length < 2) {
                        suggestions.style.display = 'none';
                        return;
                    }
                    const matches = hospitalList.filter(h =>
                        (h.n && h.n.toString().toLowerCase().includes(val)) ||
                        (h.c && h.c.toString().includes(val)) ||
                        (h.p && h.p.toString().includes(val))
                    ).slice(0, 10);

                    if (matches.length > 0) {
                        suggestions.innerHTML = matches.map(h => `
                            <div class="suggestion-item" onclick="selectSuggestion('${h.c}', '${h.n}')">
                                <div>${h.n}</div>
                                <div style="font-size:0.8em; color:#888;">${h.p ? h.p + ' | ' : ''}${h.c}</div>
                            </div>`).join('');
                        suggestions.style.display = 'block';
                    } else {
                        suggestions.style.display = 'none';
                    }
                });
                
                // Province Search Logic
                const provinceInput = document.getElementById('provinceInput');
                provinceInput.addEventListener('input', (e) => {
                    const val = e.target.value.toLowerCase();
                    const suggestions = document.getElementById('provinceSuggestions');
                    if (val.length < 1) {
                        suggestions.style.display = 'none';
                        return;
                    }
                    const provinces = [...new Set(hospitalList.map(h => h.p).filter(p => p))];
                    const matches = provinces.filter(p => p.toString().toLowerCase().includes(val)).slice(0, 10);

                    if (matches.length > 0) {
                        suggestions.innerHTML = matches.map(p => `
                            <div class="suggestion-item" onclick="selectProvinceSuggestion('${p}')">${p}</div>
                        `).join('');
                        suggestions.style.display = 'block';
                    } else {
                        suggestions.style.display = 'none';
                    }
                });

                // Close suggestions on click outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.search-box')) document.getElementById('suggestions').style.display = 'none';
                    if (!e.target.closest('.province-box')) document.getElementById('provinceSuggestions').style.display = 'none';
                });

            } catch (e) {
                alert('Failed to load hospital list: ' + e.message);
            }
        };

        window.selectSuggestion = (code, name) => {
            document.getElementById('suggestions').style.display = 'none';
            addHospital(code, name);
        };

        window.selectProvinceSuggestion = (province) => {
            document.getElementById('provinceSuggestions').style.display = 'none';
            document.getElementById('provinceInput').value = province;
        };
    </script>
</body>

</html>
