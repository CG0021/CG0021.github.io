<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตรวจสอบสิทธิประโยชน์การสร้างเสริมสุขภาพและป้องกันโรค <br></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .accordion-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .accordion-content.active {
            opacity: 1;
        }

        .rotate-180 {
            transform: rotate(180deg);
        }

        @media print {
            @page {
                size: A4;
                margin: 2cm;
            }

            body {
                background-color: white;
            }

            header,
            footer,
            .no-print {
                display: none !important;
            }

            main {
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .shadow-md,
            .shadow-lg,
            .shadow-sm {
                box-shadow: none !important;
            }

            .border {
                border: none !important;
            }

            .accordion-content {
                max-height: none !important;
                opacity: 1 !important;
                display: block !important;
            }

            .fa-chevron-down {
                display: none !important;
            }

            #results-output {
                display: block !important;
            }

            /* Custom Print Header */
            #print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
                border-bottom: 2px solid #eee !important;
                padding-bottom: 10px;
            }
        }

        #print-header {
            display: none;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                        <i class="fa-solid fa-heart-pulse text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold">ตรวจสอบสิทธิประโยชน์</h1>
                        <p class="text-xs md:text-sm text-blue-100">บริการสร้างเสริมสุขภาพและป้องกันโรค
                            <br> ได้รับการสนับสนุนโดย หลักสูตร การเงินการคลัง CFO CCO
                            สำนักบริการวิชาการ มหาวิทยาลัยมหาสารคาม
                        </p>
                    </div>
                </div>
                <div class="hidden md:block text-right text-xs text-blue-100 leading-snug">
                    <p class="text-gray-200">พัฒนาโดย&nbsp;
                        <span class="font-semibold text-white text-lg">ดร.นพ.ชุมพล นุชผ่อง</span>
                    </p>
                    <p>นายแพทย์เชี่ยวชาญ เวชกรรมป้องกัน</p>
                    <p>กองเศรษฐกิจสุขภาพและหลักประกันสุขภาพ</p>
                    <p>สำนักงานปลัดกระทรวงสาธารณสุข</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-4xl">

        <!-- Custom Print Header -->
        <div id="print-header">
            <h1 class="text-2xl font-bold text-gray-800">รายงานสิทธิประโยชน์การสร้างเสริมสุขภาพและป้องกันโรค</h1>
            <p class="text-gray-600 mt-2">ข้อมูล ณ วันที่ <span id="print-date"></span></p>
        </div>

        <!-- Input Section -->
        <div class="bg-white rounded-2xl shadow-md p-6 mb-8 border border-gray-100 no-print">
            <h2 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                <i class="fa-solid fa-user-check mr-2 text-blue-600"></i>
                ข้อมูลผู้รับบริการ
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Age Input -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">อายุ (ปี)</label>
                    <div class="relative">
                        <input type="number" id="age-input" min="0" max="120" oninput="checkEligibility()"
                            class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none"
                            placeholder="ระบุอายุ">
                        <i class="fa-solid fa-cake-candles absolute left-3 top-3.5 text-gray-400"></i>
                    </div>
                </div>

                <!-- Gender Selection -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">เพศ</label>
                    <div class="flex space-x-4">
                        <button onclick="selectGender('1')" id="btn-male"
                            class="flex-1 py-3 px-4 rounded-xl border border-gray-200 flex items-center justify-center space-x-2 transition-all hover:bg-blue-50">
                            <i class="fa-solid fa-mars text-blue-500"></i>
                            <span>ชาย</span>
                        </button>
                        <button onclick="selectGender('2')" id="btn-female"
                            class="flex-1 py-3 px-4 rounded-xl border border-gray-200 flex items-center justify-center space-x-2 transition-all hover:bg-pink-50">
                            <i class="fa-solid fa-venus text-pink-500"></i>
                            <span>หญิง</span>
                        </button>


                    </div>
                </div>
            </div>

            <!-- Special Conditions -->
            <div class="mt-6 pt-6 border-t border-gray-100">
                <label class="block text-sm font-medium text-gray-700 mb-3">เงื่อนไขเพิ่มเติม</label>
                <div class="flex flex-wrap gap-3">
                    <button onclick="toggleCondition('pregnant')" id="btn-pregnant"
                        class="px-4 py-2 rounded-full border border-gray-200 text-sm font-medium text-gray-600 transition-all hover:border-pink-300 hover:text-pink-600 hidden">
                        <i class="fa-solid fa-baby-carriage mr-1.5"></i>
                        ตั้งครรภ์
                    </button>
                    <button onclick="toggleCondition('sso')" id="btn-sso"
                        class="px-4 py-2 rounded-full border border-gray-200 text-sm font-medium text-gray-600 transition-all hover:border-blue-300 hover:text-blue-600">
                        <i class="fa-solid fa-building-shield mr-1.5"></i>
                        ผู้ประกันตน (ประกันสังคม)
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-output" class="hidden space-y-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">สิทธิประโยชน์ที่ได้รับ</h3>
                <div class="flex items-center space-x-3">
                    <span id="total-count" class="bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full">0
                        รายการ</span>
                    <button onclick="printReport()"
                        class="no-print bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-sm font-medium transition-colors flex items-center">
                        <i class="fa-solid fa-print mr-2"></i>
                        พิมพ์รายงาน
                    </button>
                </div>
            </div>

            <div id="services-container" class="space-y-4">
                <!-- Services will be injected here -->
            </div>
        </div>

    </main>

    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="container mx-auto px-4 py-6 text-center text-gray-500 text-sm">
            <p>© 2024 PP Checker. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // State
        let ppfsServices = []; // Store data from Google Sheet
        let selectedGender = null;
        let isPregnant = false;
        let isSSO = false;

        // DOM Elements
        const ageInput = document.getElementById('age-input');
        const btnMale = document.getElementById('btn-male');
        const btnFemale = document.getElementById('btn-female');
        const btnPregnant = document.getElementById('btn-pregnant');
        const btnSSO = document.getElementById('btn-sso');
        const resultsOutput = document.getElementById('results-output');
        const servicesContainer = document.getElementById('services-container');
        const totalCount = document.getElementById('total-count');

        // --- NEW: Fetch data from Google Apps Script with Loading/Error states ---
        document.addEventListener('DOMContentLoaded', () => {
            // Show initial loading state
            resultsOutput.classList.remove('hidden');
            servicesContainer.innerHTML = `
                <div class="text-center py-10 text-gray-500">
                    <i class="fa-solid fa-spinner fa-spin text-4xl mb-4 text-blue-500"></i>
                    <p class="font-semibold">กำลังโหลดข้อมูลสิทธิประโยชน์...</p>
                    <p class="text-sm">กรุณารอสักครู่</p>
                </div>
            `;

            // *** PASTE YOUR WEB APP URL HERE ***
            const webAppUrl = 'https://script.google.com/macros/s/AKfycbxOJLHqL9vtkwYvf5j8TZqJsZuLMVuBOxcerv9QocePyBnLlQOVoNqt8RUa0ochGPBH/exec'; // <--- วาง URL ใหม่ล่าสุดจากขั้นตอนที่ 2 ตรงนี้

            // --- NEW: JSONP Method to bypass CORS ---
            const script = document.createElement('script');
            // เพิ่ม callback function และ timestamp เพื่อป้องกัน cache
            script.src = `${webAppUrl}?callback=loadData&t=${new Date().getTime()}`;

            // Handle loading errors
            script.onerror = function () {
                console.error('Script loading error.');
                servicesContainer.innerHTML = `
                    <div class="text-center py-10 text-red-600 bg-red-50 rounded-lg border border-red-200">
                        <i class="fa-solid fa-circle-exclamation text-4xl mb-4"></i>
                        <p class="font-bold">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
                        <p class="text-sm text-red-500 mt-1">ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้ กรุณาตรวจสอบการตั้งค่า Deploy และการแชร์ไฟล์ Google Sheet</p>
                    </div>
                `;
            };

            document.body.appendChild(script);
        });

        // --- NEW: This function will be called by the JSONP response ---
        function loadData(data) {
            if (data && !data.error && Array.isArray(data)) {
                ppfsServices = data;
                console.log('Data loaded successfully via JSONP.');
                resultsOutput.classList.add('hidden');
                servicesContainer.innerHTML = '';
            } else {
                console.error('Error in data from Google Sheet:', data.error);
                throw new Error(data.error || 'รูปแบบข้อมูลไม่ถูกต้อง');
            }
        }

        // Functions
        function selectGender(gender) {
            selectedGender = gender;

            // Update UI
            if (gender === '1') {
                btnMale.classList.add('bg-blue-100', 'border-blue-300', 'text-blue-700');
                btnFemale.classList.remove('bg-pink-100', 'border-pink-300', 'text-pink-700');

                // Hide pregnant option for male
                btnPregnant.classList.add('hidden');
                if (isPregnant) toggleCondition('pregnant');
            } else {
                btnFemale.classList.add('bg-pink-100', 'border-pink-300', 'text-pink-700');
                btnMale.classList.remove('bg-blue-100', 'border-blue-300', 'text-blue-700');

                // Show pregnant option for female
                btnPregnant.classList.remove('hidden');
            }
            checkEligibility();
        }

        function toggleCondition(type) {
            if (type === 'pregnant') {
                isPregnant = !isPregnant;
                if (isPregnant) {
                    btnPregnant.classList.add('bg-pink-100', 'border-pink-300', 'text-pink-700');
                } else {
                    btnPregnant.classList.remove('bg-pink-100', 'border-pink-300', 'text-pink-700');
                }
            } else if (type === 'sso') {
                isSSO = !isSSO;
                if (isSSO) {
                    btnSSO.classList.add('bg-blue-100', 'border-blue-300', 'text-blue-700');
                } else {
                    btnSSO.classList.remove('bg-blue-100', 'border-blue-300', 'text-blue-700');
                }
            }
            checkEligibility();
        }

        function toggleAccordion(id) {
            const content = document.getElementById(`details-${id}`);
            const icon = document.getElementById(`icon-${id}`);

            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                content.classList.remove('active');
                icon.classList.remove('rotate-180');
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                content.classList.add('active');
                icon.classList.add('rotate-180');
            }
        }

        function toggleCategory(category) {
            const content = document.getElementById(`category-content-${category}`);
            const icon = document.getElementById(`category-icon-${category}`);

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }

        function checkEligibility() {
            const age = parseInt(ageInput.value);

            if (isNaN(age) || !selectedGender) {
                resultsOutput.classList.add('hidden');
                return;
            }

            if (ppfsServices.length === 0) {
                // This case now primarily handles the error state where data failed to load
                if (!document.querySelector('.fa-spinner')) { // Check if it's not already showing an error
                    servicesContainer.innerHTML = `
                        <div class="text-center py-10 text-yellow-600">ยังไม่มีข้อมูลสิทธิประโยชน์ กรุณารอสักครู่ หรือลองโหลดหน้าเว็บใหม่อีกครั้ง</div>
                    `;
                    resultsOutput.classList.remove('hidden');
                }
                return;
            }

            const eligibleServices = ppfsServices.filter(service => {
                const minAge = parseInt(service.minAge, 10);
                const maxAge = parseInt(service.maxAge, 10);

                // Age Check
                let ageEligible = false;
                if (minAge === 0 && maxAge === 0) {
                    ageEligible = age === 0;
                } else {
                    ageEligible = age >= minAge && age <= maxAge;
                }

                // Gender Check
                let genderEligible = false;
                const serviceGender = service.เพศ.toLowerCase();
                if (serviceGender.includes('ทุกเพศ') || serviceGender.includes('ชาย/หญิง')) {
                    genderEligible = true;
                } else if (selectedGender === '1' && serviceGender.includes('ชาย')) {
                    genderEligible = true;
                } else if (selectedGender === '2' && serviceGender.includes('หญิง')) {
                    genderEligible = true;
                }

                // Special Conditions
                if (service.ตั้งครรภ์ === 'ตั้งครรภ์' && !isPregnant) return false;
                if (service.กลุ่ม === 'ประกันสังคม' && !isSSO) return false;

                return ageEligible && genderEligible;
            });

            displayResults(eligibleServices);
        }

        function displayResults(services) {
            resultsOutput.classList.remove('hidden');
            totalCount.textContent = `${services.length} รายการ`;
            servicesContainer.innerHTML = '';

            if (services.length === 0) {
                servicesContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa-solid fa-clipboard-list text-4xl mb-3 text-gray-300"></i>
                        <p>ไม่พบสิทธิประโยชน์ที่ตรงกับเงื่อนไข</p>
                    </div>
                `;
                return;
            }

            // Group by Category
            const categories = {};
            services.forEach(service => {
                const categoryKey = service.กลุ่ม || 'ไม่ระบุกลุ่ม';
                if (!categories[categoryKey]) {
                    categories[categoryKey] = [];
                }
                categories[categoryKey].push(service);
            });

            // Render Groups
            for (const [category, items] of Object.entries(categories)) {
                const categoryHTML = `
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <button onclick="toggleCategory('${category}')" class="w-full text-left p-4 bg-gray-50 hover:bg-gray-100 flex justify-between items-center transition-colors border-b border-gray-100">
                            <div class="flex items-center space-x-2">
                                <span class="font-bold text-gray-800">${category}</span>
                                <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded-full">${items.length}</span>
                            </div>
                            <i id="category-icon-${category}" class="fa-solid fa-chevron-down transition-transform duration-300 rotate-180"></i>
                        </button>
                        <div id="category-content-${category}" class="divide-y divide-gray-100">
                            ${items.map(item => `
                                <div>
                                    <button onclick="toggleAccordion('${item.รหัส}')" class="w-full text-left p-4 hover:bg-blue-50 flex justify-between items-start transition-colors group">
                                        <div class="pr-4">
                                            <div class="font-medium text-gray-800 group-hover:text-blue-700">${item.บริการ}</div>
                                            <div class="text-xs text-gray-500 mt-1">รหัส: ${item.รหัส}</div>
                                        </div>
                                        <i id="icon-${item.รหัส}" class="fa-solid fa-chevron-down text-gray-400 mt-1 transition-transform duration-300"></i>
                                    </button>
                                    <div id="details-${item.รหัส}" class="accordion-content bg-gray-50 px-4 text-sm text-gray-600">
                                        <div class="py-3 space-y-2">
                                            <p><strong>กลุ่มเป้าหมาย:</strong> ${item.กลุ่มเป้าหมาย.replace(/\n/g, '<br>')}</p>
                                            <p><strong>ขอบเขตบริการ:</strong> ${item.ขอบเขตบริการ.replace(/\n/g, '<br>')}</p>
                                            <p><strong>เงื่อนไขและอัตราจ่าย:</strong> ${item.เงื่อนไขและอัตราจ่าย.replace(/\n/g, '<br>')}</p>
                                            <p><strong>หน่วยบริการ:</strong> ${item.หน่วยบริการ.replace(/\n/g, '<br>')}</p>
                                            <p><strong>โปรแกรม:</strong> ${item.โปรแกรม.replace(/\n/g, '<br>')}</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                servicesContainer.innerHTML += categoryHTML;
            }

            // Removed scrollIntoView to prevent jumping
        }

        function printReport() {
            const date = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('print-date').textContent = date.toLocaleDateString('th-TH', options);
            window.print();
        }
    </script>
</body>

</html>
