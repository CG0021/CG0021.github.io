<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบวิเคราะห์และประเมินประสิทธิภาพ TPS</title>
    <!-- Chart.js removed as per request -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'IBM Plex Sans Thai', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }

        .credit-box {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
            font-size: 0.8em;
            /* ขนาดตัวอักษรทั่วไป */
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.4;
        }

        /* CSS สำหรับชื่อโดยเฉพาะ */
        .credit-box .credit-name {
            font-size: 1.3em;
            /* ขยายใหญ่ขึ้น 1.4 เท่าจากตัวปกติ */
            font-weight: bold;
            /* เพิ่มตัวหนาเพื่อให้เด่นขึ้น */
            margin: 0px 0;
            /* เว้นระยะห่างบนล่างนิดหน่อยให้อ่านง่าย */
        }

        @media (max-width: 900px) {
            .credit-box {
                position: static;
                text-align: center;
                margin-top: 15px;
            }
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .search-section {
            padding: 25px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .search-box {
            display: flex;
            gap: 12px;
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 15px;
            font-family: 'IBM Plex Sans Thai', sans-serif;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .suggestion-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s ease;
        }

        .suggestion-item:hover {
            background: #f8f9fa;
        }

        button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'IBM Plex Sans Thai', sans-serif;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .button-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .results-section {
            padding: 25px 30px;
            min-height: 400px;
        }

        .hospital-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #3498db;
        }

        .hospital-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 12px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 12px;
        }

        .hospital-name {
            font-size: 1.6em;
            color: #2c3e50;
            font-weight: 600;
        }

        .hospital-code {
            background: #e74c3c;
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 1em;
        }

        .hospital-grade {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .info-item.half-width {
            grid-column: span 1;
            max-width: 50%;
        }

        @media (max-width: 600px) {
            .info-item.half-width {
                max-width: 100%;
            }
        }

        .info-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }

        .info-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 0.85em;
            margin-bottom: 4px;
        }

        .info-value {
            font-weight: 500;
            color: #2c3e50;
            font-size: 1em;
        }

        .score-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid #e9ecef;
        }

        .score-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }

        .score-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
        }

        .score-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #27ae60;
        }

        .score-grade {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .table-container {
            margin: 20px 0;
            max-height: 600px;
            overflow: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            /* Ensure scrollbar is visible for touch devices */
            -webkit-overflow-scrolling: touch;
        }

        /* Custom Scrollbar for visibility */
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 4px;
            border: 2px solid #f1f1f1;
            /* Creates padding around thumb */
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }

        .criteria-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1em;
        }

        .criteria-table th {
            background: #2c3e50;
            color: white;
            padding: 10px 6px;
            text-align: center;
            font-weight: 600;
            font-size: 0.85em;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .criteria-table td {
            padding: 8px 6px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.95em;
        }

        .criteria-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .criteria-table tr:hover {
            background: #e3f2fd;
        }

        .sub-criteria {
            background: #fafafa;
        }

        .sub-sub-criteria {
            background: #f5f5f5;
        }

        .full-score {
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
        }

        .actual-score {
            font-weight: 600;
            text-align: center;
        }

        .actual-score.zero {
            color: #e74c3c;
        }

        .actual-score:not(.zero) {
            color: #2c3e50;
        }

        .result-value {
            text-align: center;
        }

        .result-value.zero {
            color: #e74c3c;
        }

        .result-value:not(.zero) {
            color: #2c3e50;
        }

        .unit-value {
            text-align: center;
            color: #7f8c8d;
        }

        .group-value {
            text-align: center;
            color: #e67e22;
            font-weight: 500;
        }



        .diff-value {
            text-align: center;
            color: #2c3e50;
            font-weight: 500;
        }

        .diff-value.zero {
            text-align: center;
            color: #e74c3c;
            font-weight: 500;
        }

        .diff-value:not(.zero) {
            text-align: center;
            color: #2c3e50;
            font-weight: 500;
        }


        .percent-value {
            text-align: center;
            color: #2c3e50;
            font-weight: 500;
        }

        .percent-value.zero {
            text-align: center;
            color: #e74c3c;
            font-weight: 500;
        }

        .percent-value:not(.zero) {
            text-align: center;
            color: #2c3e50;
            font-weight: 500;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            height: 400px;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            margin: 15px 0;
        }

        .search-results {
            margin-bottom: 15px;
        }

        .result-count {
            color: #7f8c8d;
            margin-bottom: 12px;
            font-size: 1em;
        }

        .result-item {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #3498db;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .result-item:hover {
            transform: translateX(3px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .result-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1em;
            margin-bottom: 4px;
        }

        .result-details {
            color: #7f8c8d;
            font-size: 0.85em;
        }

        /* General Table Improvements */
        .criteria-table th {
            padding: 12px 8px;
            /* More breathing room */
            font-size: 0.95em;
            /* Larger font */
        }

        .criteria-table td {
            padding: 10px 8px;
            /* More breathing room */
            font-size: 1em;
        }

        .analysis-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            margin-top: 25px;
            margin-bottom: 10px;
        }

        @media (max-width: 900px) {
            .credit-box {
                position: static;
                text-align: center;
                margin-top: 15px;
            }

            .analysis-container {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
        }

        @media (max-width: 1200px) {
            .criteria-table {
                font-size: 0.9em;
                /* Increased from 0.8em */
            }

            .criteria-table th,
            .criteria-table td {
                padding: 8px 6px;
                /* Increased padding */
            }
        }

        @media (max-width: 768px) {
            .search-box {
                flex-direction: column;
            }

            .hospital-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Mobile adjustments for Main Criteria Table */
            .criteria-table:not(#analysisTable) {
                min-width: 100%;
                border: none;
            }

            .criteria-table:not(#analysisTable) thead {
                display: none;
            }

            .criteria-table:not(#analysisTable) tbody tr {
                display: grid;
                grid-template-columns: 1fr 1fr;
                background: white;
                margin-bottom: 15px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 12px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
                gap: 8px;
                grid-template-areas:
                    "item item"
                    "mean full"
                    "result actual"
                    "diff diff";
            }

            .criteria-table:not(#analysisTable) td {
                border: none;
                padding: 4px;
                font-size: 0.95em;
            }

            /* Hide empty cells */
            .criteria-table:not(#analysisTable) td:empty {
                display: none;
            }

            /* Line 1: Item (Col 1) */
            .criteria-table:not(#analysisTable) td:nth-child(1) {
                grid-area: item;
                font-weight: 600;
                color: #2c3e50;
                border-bottom: 1px solid #f0f0f0;
                margin-bottom: 8px;
                padding-bottom: 8px;
                font-size: 1.1em;
            }

            /* Line 2: Mean (Col 6) | Full (Col 2) */
            .criteria-table:not(#analysisTable) td:nth-child(6) {
                grid-area: mean;
                text-align: left;
            }

            .criteria-table:not(#analysisTable) td:nth-child(2) {
                grid-area: full;
                text-align: right;
            }

            /* Line 3: Result (Col 4) | Actual (Col 3) */
            .criteria-table:not(#analysisTable) td:nth-child(4) {
                grid-area: result;
                text-align: left;
            }

            .criteria-table:not(#analysisTable) td:nth-child(3) {
                grid-area: actual;
                text-align: right;
                font-weight: bold;
                color: #2c3e50;
            }

            /* Line 4: Diff (Col 7) */
            .criteria-table:not(#analysisTable) td:nth-child(7) {
                grid-area: diff;
                text-align: left;
                margin-top: 4px;
                border-top: 1px dashed #f0f0f0;
                padding-top: 8px;
            }

            /* Labels */
            .criteria-table:not(#analysisTable) td:nth-child(2)::before {
                content: "เต็ม: ";
                color: #7f8c8d;
                font-size: 0.9em;
            }

            .criteria-table:not(#analysisTable) td:nth-child(3)::before {
                content: "ได้: ";
                color: #7f8c8d;
                font-size: 0.9em;
            }

            .criteria-table:not(#analysisTable) td:nth-child(4)::before {
                content: "ผล: ";
                color: #95a5a6;
                font-size: 0.9em;
            }

            .criteria-table:not(#analysisTable) td:nth-child(6)::before {
                content: "ค่ากลาง: ";
                color: #95a5a6;
                font-size: 0.9em;
            }

            .criteria-table:not(#analysisTable) td:nth-child(7)::before {
                content: "ผลต่าง: ";
                color: #95a5a6;
                font-size: 0.9em;
            }

            /* Hide Unit (Col 5) */
            .criteria-table:not(#analysisTable) td:nth-child(5) {
                display: none;
            }

            /* Special handling for Header Rows (criteria-header) */
            .criteria-table:not(#analysisTable) tr.criteria-header {
                grid-template-areas:
                    "item item"
                    "full actual";
                padding-bottom: 8px;
            }

            /* Hide Mean, Result, Diff for headers */
            .criteria-table:not(#analysisTable) tr.criteria-header td:nth-child(4),
            .criteria-table:not(#analysisTable) tr.criteria-header td:nth-child(6),
            .criteria-table:not(#analysisTable) tr.criteria-header td:nth-child(7) {
                display: none !important;
            }

            /* Adjust alignment for headers */
            .criteria-table:not(#analysisTable) tr.criteria-header td:nth-child(2) {
                text-align: left;
            }

            .criteria-table:not(#analysisTable) tr.criteria-header td:nth-child(3) {
                text-align: right;
            }


            /* Mobile adjustments for Analysis Table - Stacked Layout */
            #analysisTable thead {
                display: none;
            }

            #analysisTable tbody tr {
                display: block;
                margin-bottom: 20px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
                background: white;
            }

            #analysisTable td {
                display: block;
                width: 100% !important;
                text-align: left;
                border-bottom: 1px solid #f0f0f0;
                padding: 12px 15px;
            }

            #analysisTable td:last-child {
                border-bottom: none;
            }

            /* Hide Result (2) and Criteria (3) */
            #analysisTable th:nth-child(2),
            #analysisTable td:nth-child(2),
            #analysisTable th:nth-child(3),
            #analysisTable td:nth-child(3) {
                display: none;
            }

            /* Item (1) */
            #analysisTable td:nth-child(1) {
                background-color: #f8f9fa;
                color: #2c3e50;
                font-weight: bold;
                font-size: 1.1em;
                border-left: 5px solid #e67e22;
                border-radius: 8px 8px 0 0;
            }

            /* Solution (4) */
            #analysisTable td:nth-child(4) {
                color: #34495e;
                line-height: 1.6;
            }

            #analysisTable td:nth-child(4)::before {
                content: "แนวทางแก้ไข:";
                font-weight: 600;
                color: #e67e22;
                display: block;
                margin-bottom: 5px;
            }

            /* Responsible (5) */
            #analysisTable td:nth-child(5) {
                display: block;
                color: #7f8c8d;
                font-size: 0.95em;
                background-color: #fafafa;
                border-radius: 0 0 8px 8px;
            }

            #analysisTable td:nth-child(5)::before {
                content: "ผู้รับผิดชอบ: ";
                font-weight: 600;
                color: #34495e;
                display: inline-block;
                margin-right: 5px;
            }

            #analysisTable {
                min-width: 100%;
                border: none;
            }

            /* Button adjustments for mobile */
            button {
                width: 100%;
                white-space: normal;
                padding: 12px 15px;
            }

            .button-group {
                flex-direction: column;
            }

            .analysis-container button {
                width: 100%;
                font-size: 1em !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ระบบวิเคราะห์และประเมินประสิทธิภาพ TPS</h1>
            <p>ได้รับการสนับสนุนโดย หลักสูตร การเงินการคลัง CFO CCO สำนักบริการวิชาการ มหาวิทยาลัยมหาสารคาม</p>
            <div class="credit-box">
                ออกแบบและพัฒนาโดย <br>
                <div class="credit-name">ดร.นพ.ชุมพล นุชผ่อง</div>
                นายแพทย์เชี่ยวชาญ เวชกรรมป้องกัน<br>
                กองเศรษฐกิจสุขภาพและหลักประกันสุขภาพ<br>
                สำนักงานปลัดกระทรวงสาธารณสุข

            </div>
        </div>

        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="กำลังโหลดรายชื่อโรงพยาบาล..." disabled>
                <button id="searchBtn">ค้นหา</button>
                <div class="suggestions" id="suggestions"></div>
            </div>

        </div>

        <div class="results-section">
            <div id="loading" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>กำลังโหลดข้อมูล....</p>
            </div>
            <div id="results">
                <div class="hospital-card">
                    <h3 style="color: #2c3e50; margin-bottom: 12px;">ยินดีต้อนรับสู่ระบบค้นหาชื่อโรงพยาบาล</h3>
                    <p style="color: #7f8c8d; margin-bottom: 12px;">ระบบนี้ดึงข้อมูลจาก Google Sheets โดยตรง</p>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">พิมพ์ชื่อบางส่วน</div>
                            <div class="info-value">เช่น "เชียงราย", "ประชา"</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">รหัสโรงพยาบาล</div>
                            <div class="info-value">เช่น "10674"</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">จังหวัดหรือเขต</div>
                            <div class="info-value">เช่น "กรุงเทพ", "เชียงใหม่", "เหนือ"</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Radar Chart removed -->
        </div>
    </div>

    <script>
        // ตัวแปรเก็บรายชื่อโรงพยาบาล (ชื่อ + รหัส)
        window.hospitalList = [];
        // ตัวแปรเก็บข้อมูลรายละเอียดโรงพยาบาลที่เลือก
        window.hospitalData = null;

        // 1. ฟังก์ชันดึงรายชื่อโรงพยาบาล (โหลดเร็ว)
        async function fetchHospitalList() {
            return new Promise((resolve, reject) => {
                showLoading();

                const callbackName = 'hospitalListCallback_' + Date.now();
                window[callbackName] = function (data) {
                    delete window[callbackName];
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                    hideLoading();
                    if (data.error) {
                        reject(new Error(data.message));
                    } else {
                        window.hospitalList = data.list || [];
                        const searchInput = document.getElementById('searchInput');
                        searchInput.disabled = false;
                        searchInput.placeholder = "ป้อนชื่อโรงพยาบาล, เขต, จังหวัด หรือรหัสโรงพยาบาล...";
                        resolve(window.hospitalList);
                    }
                };

                const script = document.createElement('script');
                // เรียกใช้ action=list
                script.src = `https://script.google.com/macros/s/AKfycbyO26iU11w8EnwnWIz3d1S5uEYmBbUrzIgK3PXooMajmblDAppEuPAqsykGN7XY8uFB/exec?action=list&callback=${callbackName}`;

                script.onerror = function () {
                    delete window[callbackName];
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                    hideLoading();
                    reject(new Error('ไม่สามารถโหลดรายชื่อโรงพยาบาลได้'));
                };

                document.head.appendChild(script);
            });
        }

        // 2. ฟังก์ชันดึงข้อมูลรายละเอียด (เมื่อเลือกโรงพยาบาล)
        async function fetchHospitalDetails(code) {
            return new Promise((resolve, reject) => {
                showLoading();

                const callbackName = 'hospitalDataCallback_' + Date.now();
                window[callbackName] = function (data) {
                    delete window[callbackName];
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                    hideLoading();
                    if (data.error) {
                        reject(new Error(data.message));
                    } else {
                        resolve(data);
                    }
                };

                const script = document.createElement('script');
                // เรียกใช้ action=data&code=...
                script.src = `https://script.google.com/macros/s/AKfycbyO26iU11w8EnwnWIz3d1S5uEYmBbUrzIgK3PXooMajmblDAppEuPAqsykGN7XY8uFB/exec?action=data&code=${code}&callback=${callbackName}`;

                script.onerror = function () {
                    delete window[callbackName];
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                    hideLoading();
                    reject(new Error('ไม่สามารถโหลดข้อมูลรายละเอียดได้'));
                };

                document.head.appendChild(script);
            });
        }

        // ฟังก์ชันค้นหาโรงพยาบาลในเครื่อง (จาก window.hospitalList)
        function fuzzySearchHospital(query) {
            if (!window.hospitalList || window.hospitalList.length === 0 || !query) return [];

            const queryLower = query.toLowerCase().trim();
            const results = [];
            let count = 0;

            for (const item of window.hospitalList) {
                if (count > 20) break; // จำกัดผลลัพธ์เพื่อความเร็ว

                const name = String(item.n || '');
                const code = String(item.c || '');

                let score = 0;
                let matchType = '';

                if (name.includes(query)) {
                    score = 1.0;
                    matchType = 'ชื่อตรงกัน';
                } else if (code.includes(query)) {
                    score = 1.0;
                    matchType = 'รหัสตรงกัน';
                } else if (name.toLowerCase().includes(queryLower)) {
                    score = 0.8;
                    matchType = 'ชื่อคล้าย';
                }

                if (score > 0) {
                    results.push({
                        name: name,
                        code: code,
                        matchType: matchType,
                        score: score
                    });
                    count++;
                }
            }

            return results.sort((a, b) => b.score - a.score);
        }

        // ฟังก์ชันแสดงคำแนะนำขณะพิมพ์
        function showSuggestions(query) {
            const suggestionsDiv = document.getElementById('suggestions');

            if (!query || query.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            const results = fuzzySearchHospital(query);

            if (results.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            suggestionsDiv.innerHTML = results.map(result => `
                <div class="suggestion-item" onclick="selectHospitalByCode('${result.code}')">
                    <div style="font-weight: 600;">${result.name}</div>
                    <div style="font-size: 0.85em; color: #666;">
                        ${result.code} • ${result.matchType}
                    </div>
                </div>
            `).join('');

            suggestionsDiv.style.display = 'block';
        }

        // ฟังก์ชันเลือกโรงพยาบาลจากรหัส
        async function selectHospitalByCode(code) {
            document.getElementById('suggestions').style.display = 'none';
            try {
                // โหลดข้อมูลรายละเอียด
                const data = await fetchHospitalDetails(code);
                window.hospitalData = data;

                // ตรวจสอบข้อมูลหลัก
                if (data.main && data.main.length >= 2) {
                    const result = {
                        headers: data.main[0],
                        row: data.main[1]
                    };

                    // แสดงผล
                    displayHospitalData(result);

                    // อัปเดตช่องค้นหา
                    const nameIdx = result.headers.findIndex(h => String(h).includes('โรงพยาบาล'));
                    if (nameIdx !== -1) {
                        document.getElementById('searchInput').value = result.row[nameIdx];
                    }
                } else {
                    alert('ไม่พบข้อมูลรายละเอียดของโรงพยาบาลนี้');
                }
            } catch (error) {
                console.error(error);
                alert('เกิดข้อผิดพลาด: ' + error.message);
            }
        }

        // ฟังก์ชันหาข้อมูลจากชีทอื่นโดยใช้รหัสโรงพยาบาล
        function findHospitalInSheet(sheetData, hospitalCode) {
            if (!sheetData || sheetData.error || !Array.isArray(sheetData)) return null;

            const codeIndex = sheetData[0].findIndex(h => h && h.toString().includes('รหัส'));
            if (codeIndex === -1) return null;

            for (let i = 1; i < sheetData.length; i++) {
                if (sheetData[i][codeIndex] == hospitalCode) {
                    return {
                        headers: sheetData[0],
                        row: sheetData[i]
                    };
                }
            }
            return null;
        }

        // ฟังก์ชันจัดรูปแบบตัวเลข
        function formatNumber(num) {
            if (num === null || num === undefined || num === '') return '0';
            if (typeof num === 'string') {
                num = parseFloat(num.replace(/,/g, ''));
            }
            if (isNaN(num)) return '0';
            return new Intl.NumberFormat('th-TH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }

        // ฟังก์ชันดึงค่าจากแถวข้อมูล
        function getValue(row, headers, columnName) {
            if (!row || !headers) return null;
            const index = headers.findIndex(h => h && h.toString().includes(columnName));
            return index !== -1 ? row[index] : null;
        }

        // ฟังก์ชันตรวจสอบว่าเป็น 0 หรือไม่
        function isZero(value) {
            if (value === null || value === undefined || value === '') return false;
            const num = parseFloat(value);
            return !isNaN(num) && num === 0;
        }

        // ฟังก์ชันแสดงผลข้อมูลโรงพยาบาล
        function displayHospitalData(result) {
            const resultsDiv = document.getElementById('results');

            if (!result) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>ไม่พบข้อมูลโรงพยาบาลที่ค้นหา</h3>
                        <p>กรุณาลองค้นหาใหม่หรือตรวจสอบการสะกด</p>
                    </div>
                `;
                return;
            }

            const { headers, row } = result;
            const hospitalCode = getValue(row, headers, 'รหัส');

            // ดึงข้อมูลจากชีทอื่นๆ
            const qmData = findHospitalInSheet(window.hospitalData.qm, hospitalCode);
            const hgrData = findHospitalInSheet(window.hospitalData.hgr, hospitalCode);
            const occupancyData = findHospitalInSheet(window.hospitalData.occupancy, hospitalCode);
            const ratioData = findHospitalInSheet(window.hospitalData.ratio, hospitalCode);

            // ดึงค่าจากข้อมูลหลัก
            const hospitalName = getValue(row, headers, 'โรงพยาบาล') || 'ไม่ระบุชื่อ';
            const grade = getValue(row, headers, 'TPS Grade') || 'E';
            const totalScore = getValue(row, headers, 'คะแนนประเมินประสิทธิภาพ') || '14.5';
            const riskScore = getValue(row, headers, 'RiskScore') || '0';
            const nwc = getValue(row, headers, 'ทุนสำรองสุทธิ(NWC)');
            const fundBalance = getValue(row, headers, 'เงินบำรุงคงเหลือสุทธิ');
            const ebitda = getValue(row, headers, 'EBITDA');
            const ni = getValue(row, headers, 'รายได้สุง (ต่ำ)กว่าค่าใช้จ่ายสุทธิ (NI)');



            // ดึงคะแนนย่อยต่างๆ
            const score1_1 = getValue(row, headers, 'คะแนน 1.1');
            const score1_1_1 = getValue(row, headers, 'P_รายได้');
            const score1_1_2 = getValue(row, headers, 'P_ค่าใช้จ่าย');

            const score1_2 = getValue(row, headers, 'คะแนน1.2');
            const score1_3_1 = getValue(row, headers, '1.3.1');
            const score1_3_2 = getValue(row, headers, '1.3.2 ตรวจสอบงบทดลอง');
            const score1_3_3 = getValue(row, headers, 'คะแนน 1.3.3');
            const score2 = getValue(row, headers, 'คะแนน 2 ตัวชี้วัดผลการดำเนินงาน');
            const score2_1 = getValue(row, headers, 'คะแนน 2.1');
            const score2_2 = getValue(row, headers, 'คะแนน 2.2');
            const P_nwc = getValue(row, headers, 'P_NWC');


            // ดึงข้อมูลจากชีท QM
            const opCost = getValue(qmData?.row, qmData?.headers, 'ต้นทุนบริการผู้ป่วยนอกต่อครั้ง');
            const ipCost = getValue(qmData?.row, qmData?.headers, 'ต้นทุนบริการผู้ป่วยในต่อ AdjRW');
            const opMean = getValue(qmData?.row, qmData?.headers, 'Mean+1SD(ผู้ป่วยนอก)');
            const ipMean = getValue(qmData?.row, qmData?.headers, 'Mean+1SD(ผู้ป่วยใน)');

            // ดึงข้อมูลจากชีท HGR
            const lc = getValue(hgrData?.row, hgrData?.headers, 'LC');
            const drugCost = getValue(hgrData?.row, hgrData?.headers, 'ค่ายา');
            const scienceCost = getValue(hgrData?.row, hgrData?.headers, 'ค่าวัสดุวิทยาศาสตร์และการแพทย์');
            const medicalCost = getValue(hgrData?.row, hgrData?.headers, 'ค่าเวชภัณฑ์มิใช่ยาและวัสดุการแพทย์');
            const lcMean = getValue(hgrData?.row, hgrData?.headers, 'Mean#LC');
            const drugMean = getValue(hgrData?.row, hgrData?.headers, 'Mean#ค่ายา');
            const scienceMean = getValue(hgrData?.row, hgrData?.headers, 'Mean#ค่าวัสดุวิทยาศาสตร์และการแพทย์');
            const medicalMean = getValue(hgrData?.row, hgrData?.headers, 'Mean#ค่าเวชภัณฑ์มิใช่ยาและวัสดุการแพทย์');
            const lcDiff = getValue(hgrData?.row, hgrData?.headers, 'ผลต่างLC');
            const drugDiff = getValue(hgrData?.row, hgrData?.headers, 'ผลต่างค่ายา');
            const scienceDiff = getValue(hgrData?.row, hgrData?.headers, 'ผลต่างค่าวัสดุวิทยาศาสตร์และการแพทย์');
            const medicalDiff = getValue(hgrData?.row, hgrData?.headers, 'ผลต่างค่าเวชภัณฑ์มิใช่ยาและวัสดุการแพทย์');

            // ดึงข้อมูลจากชีท Occupancy
            const bedOccupancy = getValue(occupancyData?.row, occupancyData?.headers, '%อัตราครองเตียง');
            const sumAdjRW = getValue(occupancyData?.row, occupancyData?.headers, '2568Q4');
            const groupMean = getValue(occupancyData?.row, occupancyData?.headers, 'ค่ากลางกลุ่ม');
            const compareResult = getValue(occupancyData?.row, occupancyData?.headers, 'ผลเปรียบเทียบค่ากลางกลุ่ม');
            const increasePercent = getValue(occupancyData?.row, occupancyData?.headers, '%ที่เพิ่มขึ้น');

            // ดึงข้อมูลจากชีท Ratio
            const opm = getValue(ratioData?.row, ratioData?.headers, 'Ratio_OPM');
            const roa = getValue(ratioData?.row, ratioData?.headers, 'Ratio_ROA');
            const cashRatio = getValue(ratioData?.row, ratioData?.headers, 'Cash R');
            const opmMean = getValue(ratioData?.row, ratioData?.headers, 'Ratio_OPMค่ากลาง');
            const roaMean = getValue(ratioData?.row, ratioData?.headers, 'Ratio_ROAค่ากลาง');


            // สร้าง HTML
            const hospitalCard = `
                <div class="hospital-card">
                    <div class="hospital-header">
                        <div class="hospital-name">${hospitalName}</div>
                        <div class="hospital-code">${hospitalCode}</div>
                        <div class="hospital-grade">ระดับ ${grade}</div>
                    </div>
                    
                    <div class="score-section">
                        <div class="score-header">
                            <div class="score-title">ผลการประเมินประสิทธิภาพ</div>
                            <div class="score-value">${totalScore} คะแนน</div>
                            <div class="score-grade">ระดับ ${grade}</div>
                        </div>
                        
                        <div class="info-grid">
                            <div class="info-item" style="flex: 0 0 50%; max-width: 200px;">
                                <div class="info-label">Risk score</div>
                                <div class="info-value">${riskScore}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">เงินทุนสำรองสุทธิ (NWC)</div>
                                <div class="info-value">${formatNumber(nwc)} บาท</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">เงินบำรุงคงเหลือสุทธิ</div>
                                <div class="info-value">${formatNumber(fundBalance)} บาท</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">EBITDA</div>
                                <div class="info-value">${formatNumber(ebitda)} บาท</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">รายได้สูงกว่าค่าใช้จ่ายสุทธิ (NI)</div>
                                <div class="info-value">${formatNumber(ni)} บาท</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ตารางเกณฑ์ประสิทธิภาพ -->
                    <div style="margin-top: 20px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 8px;">
                            เกณฑ์ประสิทธิภาพ
                        </h3>
                        
                        <div class="table-container">
                            <table class="criteria-table">
                                <thead>
                                    <tr>
                                        <th style="width: 35%;">รายการ</th>
                                        <th style="width: 5%;">เต็ม</th>
                                        <th style="width: 5%;">ได้</th>
                                        <th style="width: 12%;">ผล</th>
                                        <th style="width: 4%;"></th>
                                        <th style="width: 12%;">ค่ากลางกลุ่ม</th>
                                        <th style="width: 15%;">ผลต่าง</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- รวมคะแนน -->
                                    <tr style="background: #e3f2fd;">
                                        <td><strong>รวม</strong></td>
                                        <td class="full-score">15.0</td>
                                        <td class="actual-score ${isZero(totalScore) ? 'zero' : ''}">${totalScore || '0'}</td>
                                        <td class="result-value"></td>
                                        <td class="unit-value"></td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 1. ตัวชี้วัดกระบวนการ -->
                                    <tr class="criteria-header">
                                        <td><strong>1. ตัวชี้วัดกระบวนการ (Process Indicators)</strong></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                    
                                    <!-- 1.1 -->
                                    <tr class="sub-criteria criteria-header">
                                        <td>1.1 การบริหารแผนทางการเงินเปรียบเทียบผลการดำเนินงานผลต่าง</td>
                                        <td class="full-score">2.0</td>
                                        <td class="actual-score ${isZero(score1_1) ? 'zero' : ''}">${score1_1 || '0'}</td>
                                        <td class="result-value"></td>
                                        <td class="unit-value"></td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 1.1.1 -->
                                    <tr class="sub-sub-criteria">
                                        <td>1.1.1 มิติรายได้ ± ไม่เกิน 5 %</td>
                                        <td class="full-score">1.0</td>
                                        <td class="actual-score ${isZero(score1_1_1) ? 'zero' : ''}">${score1_1_1 || '0'}</td>
                                        <td class="result-value"></td>
                                        <td class="unit-value">%</td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 1.1.2 -->
                                    <tr class="sub-sub-criteria">
                                        <td>1.1.2 มิติค่าใช้จ่าย ± ไม่เกิน 5 %</td>
                                        <td class="full-score">1.0</td>
                                        <td class="actual-score ${isZero(score1_1_2) ? 'zero' : ''}">${score1_1_2 || '0'}</td>
                                        <td class="result-value"></td>
                                        <td class="unit-value">%</td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 1.2 -->
                                    <tr class="sub-criteria criteria-header">
                                        <td>1.2 การบริหารสินทรัพย์หมุนเวียนและหนี้สินหมุนเวียน (3 คะแนน)</td>
                                        <td class="full-score">3.0</td>
                                        <td class="actual-score ${isZero(score1_2) ? 'zero' : ''}">${score1_2 || '0'}</td>
                                        <td class="result-value"></td>
                                        <td class="unit-value"></td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 1.2.1 -->
                                    <tr class="sub-sub-criteria">
                                        <td>1.2.1 ระยะเวลาชำระเจ้าหนี้การค้ายา&เวชภัณฑ์มิใช่ยา ≤ 90 วัน หรือ ≤ 180 วัน</td>
                                        <td class="full-score">1.0</td>
                                        <td class="actual-score ${isZero(getValue(row, headers, 'P_App-D')) ? 'zero' : ''}">${getValue(row, headers, 'P_App-D') || '0'}</td>
                                        <td class="result-value"${isZero(getValue(row, headers, 'P_App-D')) ? 'zero' : ''}">${getValue(row, headers, 'App-D') || '0'}</td>
                                        <td class="unit-value">วัน</td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 1.2.2 -->
                                    <tr class="sub-sub-criteria">
                                        <td>1.2.2 ระยะเวลาถัวเฉลี่ยในการเรียกเก็บหนี้สิทธิ UC ≤60 วัน</td>
                                        <td class="full-score">0.5</td>
                                        <td class="actual-score ${isZero(getValue(row, headers, 'P_acp uc')) ? 'zero' : ''}">${getValue(row, headers, 'P_acp uc') || '0'}</td>
                                        <td class="result-value ${isZero(getValue(row, headers, 'P_acp uc')) ? 'zero' : ''}">${getValue(row, headers, 'ACP:UC') || '0'}</td>
                                        <td class="unit-value">วัน</td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 1.2.3 -->
                                    <tr class="sub-sub-criteria">
                                        <td>1.2.3 ระยะเวลาถัวเฉลี่ยในการเรียกเก็บหนี้สิทธิข้าราชการ ≤60 วัน</td>
                                        <td class="full-score">0.5</td>
                                        <td class="actual-score ${isZero(getValue(row, headers, 'P_acp cs')) ? 'zero' : ''}">${getValue(row, headers, 'P_acp cs') || '0'}</td>
                                        <td class="result-value ${isZero(getValue(row, headers, 'P_acp cs')) ? 'zero' : ''}">${getValue(row, headers, 'ACP:CS') || '0'}</td>
                                        <td class="unit-value">วัน</td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 1.2.4 -->
                                    <tr class="sub-sub-criteria">
                                        <td>1.2.4 การบริหารสินคงคลัง (Inventory Management) ≤ 60 วัน ยกเว้น รพ.พื้นที่เกาะ ≤ 90 วัน</td>
                                        <td class="full-score">1.0</td>
                                        <td class="actual-score ${isZero(getValue(row, headers, 'P_Aip')) ? 'zero' : ''}">${getValue(row, headers, 'P_Aip') || '0'}</td>
                                        <td class="result-value ${isZero(getValue(row, headers, 'P_Aip')) ? 'zero' : ''}">${getValue(row, headers, 'AIP') || '0'}</td>
                                        <td class="unit-value">วัน</td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 1.3 -->
                                    <tr class="sub-criteria criteria-header">
                                        <td>1.3 การบริหารจัดการ</td>
                                        <td class="full-score">5.0</td>
                                        <td class="actual-score ${isZero(score1_3_1) && isZero(score1_3_2) && isZero(score1_3_3) ? 'zero' : ''}">${(parseFloat(score1_3_1 || 0) + parseFloat(score1_3_2 || 0) + parseFloat(score1_3_3 || 0)).toFixed(1)}</td>
                                        <td class="result-value"></td>
                                        <td class="unit-value"></td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 1.3.1 -->
                                    <tr class="sub-sub-criteria criteria-header">
                                        <td>1.3.1 การบริหารต้นทุนและค่าใช้จ่าย (2 คะแนน)</td>
                                        <td class="full-score">2.0</td>
                                        <td class="actual-score ${isZero(score1_3_1) ? 'zero' : ''}">${score1_3_1 || '0'}</td>
                                        <td class="result-value"></td>
                                        <td class="unit-value"></td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 1.3.1.1 -->
                                    <tr>
                                        <td style="padding-left: 40px;">1.3.1.1 Unit Cost for OP</td>
                                        <td class="full-score">1.0</td>
                                        <td class="actual-score ${isZero(getValue(row, headers, 'QM-OP')) ? 'zero' : ''}">${getValue(row, headers, 'QM-OP') || '0'}</td>
                                        <td class="result-value ${isZero(getValue(row, headers, 'QM-OP')) ? 'zero' : ''}">${formatNumber(opCost)}</td>
                                        <td class="unit-value">บาท</td>
                                        <td class="group-value">${formatNumber(opMean)}</td>
                                        <td class="diff-value ${isZero(getValue(row, headers, 'QM-OP')) ? 'zero' : ''}">${opCost && opMean ? formatNumber(opCost - opMean) : '0'}</td>
                                    </tr>
                                    
                                    <!-- 1.3.1.2 -->
                                    <tr>
                                        <td style="padding-left: 40px;">1.3.1.2 Unit Cost for IP</td>
                                        <td class="full-score">1.0</td>
                                        <td class="actual-score ${isZero(getValue(row, headers, 'QM-IP')) ? 'zero' : ''}">${getValue(row, headers, 'QM-IP') || '0'}</td>
                                        <td class="result-value ${isZero(getValue(row, headers, 'QM-IP')) ? 'zero' : ''}">${formatNumber(ipCost)}</td>
                                        <td class="unit-value">บาท</td>
                                        <td class="group-value">${formatNumber(ipMean)}</td>
                                        <td class="diff-value ${isZero(getValue(row, headers, 'QM-IP')) ? 'zero' : ''}">${ipCost && ipMean ? formatNumber(ipCost - ipMean) : '0'}</td>
                                    </tr>
                                    
                                    <!-- 1.3.1.3 -->
                                    <tr>
                                        <td style="padding-left: 40px;">1.3.1.3 LC ค่าแรงบุคลากร</td>
                                        <td class="full-score">0.5</td>
                                        <td class="actual-score ${isZero(getValue(row, headers, 'LC')) ? 'zero' : ''}">${getValue(row, headers, 'LC') || '0'}</td>
                                        <td class="result-value ${isZero(getValue(row, headers, 'LC')) ? 'zero' : ''}">${formatNumber(lc)}</td>
                                        <td class="unit-value">บาท</td>
                                        <td class="group-value">${formatNumber(lcMean)}</td>
                                        <td class="diff-value ${isZero(getValue(row, headers, 'LC')) ? 'zero' : ''} ">${formatNumber(lcDiff)}</td>
                                    </tr>
                                    
                                    <!-- 1.3.1.4 -->
                                    <tr>
                                        <td style="padding-left: 40px;">1.3.1.4 MC ค่ายา</td>
                                        <td class="full-score">0.5</td>
                                        <td class="actual-score ${isZero(getValue(row, headers, 'ค่ายา')) ? 'zero' : ''}">${getValue(row, headers, 'ค่ายา') || '0'}</td>
                                        <td class="result-value ${isZero(getValue(row, headers, 'ค่ายา')) ? 'zero' : ''}">${formatNumber(drugCost)}</td>
                                        <td class="unit-value">บาท</td>
                                        <td class="group-value">${formatNumber(drugMean)}</td>
                                        <td class="diff-value ${isZero(getValue(row, headers, 'ค่ายา')) ? 'zero' : ''}">${formatNumber(drugDiff)}</td>
                                    </tr>
                                    
                                    <!-- 1.3.1.5 -->
                                    <tr>
                                        <td style="padding-left: 40px;">1.3.1.5 MC ค่าวัสดุวิทยาศาสตร์และการแพทย์</td>
                                        <td class="full-score">0.5</td>
                                        <td class="actual-score ${isZero(getValue(row, headers, 'ค่าวัสดุวิทยาศาสตร์และการแพทย์')) ? 'zero' : ''}">${getValue(row, headers, 'ค่าวัสดุวิทยาศาสตร์และการแพทย์') || '0'}</td>
                                        <td class="result-value ${isZero(getValue(row, headers, 'ค่าวัสดุวิทยาศาสตร์และการแพทย์')) ? 'zero' : ''}">${formatNumber(scienceCost)}</td>
                                        <td class="unit-value">บาท</td>
                                        <td class="group-value">${formatNumber(scienceMean)}</td>
                                        <td class="diff-value ${isZero(getValue(row, headers, 'ค่าวัสดุวิทยาศาสตร์และการแพทย์')) ? 'zero' : ''}">${formatNumber(scienceDiff)}</td>
                                    </tr>
                                    
                                    <!-- 1.3.1.6 -->
                                    <tr>
                                        <td style="padding-left: 40px;">1.3.1.6 MC ค่าเวชภัณฑ์มิใช่ยาและวัสดุการแพทย์</td>
                                        <td class="full-score">0.5</td>
                                        <td class="actual-score ${isZero(getValue(row, headers, 'ค่าเวชภัณฑ์มิใช่ยาและวัสดุการแพทย์')) ? 'zero' : ''}">${getValue(row, headers, 'ค่าเวชภัณฑ์มิใช่ยาและวัสดุการแพทย์') || '0'}</td>
                                        <td class="result-value ${isZero(getValue(row, headers, 'ค่าเวชภัณฑ์มิใช่ยาและวัสดุการแพทย์')) ? 'zero' : ''}">${formatNumber(medicalCost)}</td>
                                        <td class="unit-value">บาท</td>
                                        <td class="group-value">${formatNumber(medicalMean)}</td>
                                        <td class="diff-value ${isZero(getValue(row, headers, 'ค่าเวชภัณฑ์มิใช่ยาและวัสดุการแพทย์')) ? 'zero' : ''}">${formatNumber(medicalDiff)}</td>
                                    </tr>
                                    
                                    <!-- 1.3.2 -->
                                    <tr class="sub-sub-criteria">
                                        <td>1.3.2 คะแนนตรวจสอบงบทดลองเบื้องต้น</td>
                                        <td class="full-score">1.0</td>
                                        <td class="actual-score ${isZero(score1_3_2) ? 'zero' : ''}">${score1_3_2 || '0'}</td>
                                        <td class="result-value"></td>
                                        <td class="unit-value"></td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 1.3.3 -->
                                    <tr class="sub-sub-criteria criteria-header">
                                        <td>1.3.3 ผลผลิต (Productivity) เป็นที่ยอมรับ</td>
                                        <td class="full-score">2.0</td>
                                        <td class="actual-score ${isZero(score1_3_3) ? 'zero' : ''}">${score1_3_3 || '0'}</td>
                                        <td class="result-value"></td>
                                        <td class="unit-value"></td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 1.3.3.1 -->
                                    <tr>
                                        <td style="padding-left: 40px;">1.3.3.1 อัตราครองเตียงผู้ป่วยใน ≥ 80 %</td>
                                        <td class="full-score">1.0</td>
                                        <td class="actual-score ${isZero(getValue(row, headers, 'อัตราครองเตียง')) ? 'zero' : ''}">${getValue(row, headers, 'อัตราครองเตียง') || '0'}</td>                                      
                                        <td class="result-value ${isZero(getValue(row, headers, 'อัตราครองเตียง')) ? 'zero' : ''}"> ${formatNumber(bedOccupancy)}</td>
                                        <td class="unit-value">%</td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 1.3.3.2 -->
                                    <tr>
                                        <td style="padding-left: 40px;">1.3.3.2 SumAdjRW เกินค่ากลางกลุ่มรพ. หรือเพิ่มขึ้น 5 %</td>
                                        <td class="full-score">1.0</td>
                                        <td class="actual-score ${isZero(getValue(row, headers, 'Sum AdjRW')) ? 'zero' : ''}">${getValue(row, headers, 'Sum AdjRW') || '0'}</td>
                                        <td class="result-value ${isZero(getValue(row, headers, 'Sum AdjRW')) ? 'zero' : ''}">${formatNumber(sumAdjRW)}</td>
                                        <td class="unit-value"></td>
                                        <td class="group-value">${formatNumber(groupMean)}</td>
                                        <td class="diff-value ${isZero(getValue(row, headers, 'Sum AdjRW')) ? 'zero' : ''} ">${formatNumber(compareResult)}<br>เปลี่ยนแปลง ${formatNumber(increasePercent)}% </td>
                                       
                                    </tr>
                                    
                                    <!-- 2. ตัวชี้วัดผลลัพท์การดำเนินงาน -->
                                    <tr class="criteria-header">
                                        <td><strong>2. ตัวชี้วัดผลลัพท์การดำเนินงาน</strong></td>
                                        <td class="full-score">5.0</td>
                                        <td class="actual-score ${isZero(score2) ? 'zero' : ''}">${score2 || '0'}</td>
                                        <td class="result-value"></td>
                                        <td class="unit-value"></td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 2.1 -->
                                    <tr class="sub-criteria criteria-header">
                                        <td>2.1 ความสามารถในการทำกำไร</td>
                                        <td class="full-score">3.0</td>
                                        <td class="actual-score ${isZero(score2_1) ? 'zero' : ''}">${score2_1 || '0'}</td>
                                        <td class="result-value"></td>
                                        <td class="unit-value"></td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 2.1.1 -->
                                    <tr class="sub-sub-criteria">
                                        <td>2.1.1 ประสิทธิภาพในการดำเนินงาน (Operating Margin)</td>
                                        <td class="full-score">1.0</td>
                                        <td class="actual-score ${isZero(getValue(row, headers, 'OPM')) ? 'zero' : ''}">${getValue(row, headers, 'OPM') || '0'}</td>
                                        <td class="result-value ${isZero(getValue(row, headers, 'OPM')) ? 'zero' : ''}">${formatNumber(opm)}</td>
                                        <td class="unit-value">%</td>
                                        <td class="group-value">${formatNumber(opmMean)}</td>
                                        <td class="diff-value ${isZero(getValue(row, headers, 'OPM')) ? 'zero' : ''}">${opm && opmMean ? formatNumber(opm - opmMean) : '0'}</td>
                                    </tr>
                                    
                                    <!-- 2.1.2 -->
                                    <tr class="sub-sub-criteria">
                                        <td>2.1.2 อัตราผลตอบแทนจากสินทรัพย์ (Return on Asset)</td>
                                        <td class="full-score">1.0</td>
                                        <td class="actual-score ${isZero(getValue(row, headers, 'ROA')) ? 'zero' : ''}">${getValue(row, headers, 'ROA') || '0'}</td>
                                        <td class="result-value ${isZero(getValue(row, headers, 'ROA')) ? 'zero' : ''}">${formatNumber(roa)}</td>
                                        <td class="unit-value">%</td>
                                        <td class="group-value">${formatNumber(roaMean)}</td>
                                        <td class="diff-value ${isZero(getValue(row, headers, 'ROA')) ? 'zero' : ''}">${roa && roaMean ? formatNumber(roa - roaMean) : '0'}</td>
                                    </tr>
                                    
                                    <!-- 2.1.3 -->
                                    <tr class="sub-sub-criteria">
                                        <td>2.1.3 ผลกำไรขาดทุนก่อนหักค่าเสื่อม (EBITDA) ≥0</td>
                                        <td class="full-score">1.0</td>
                                        <td class="actual-score ${isZero(getValue(row, headers, 'EBITDA_Score')) ? 'zero' : ''}">${getValue(row, headers, 'EBITDA_Score') || '0'}</td>
                                        <td class="result-value ${isZero(getValue(row, headers, 'EBITDA_Score')) ? 'zero' : ''}">${formatNumber(ebitda)}</td>
                                        <td class="unit-value">บาท</td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 2.2 -->
                                    <tr class="sub-criteria criteria-header">
                                        <td>2.2 การวัดสภาพคล่องทางการเงิน</td>
                                        <td class="full-score">2.0</td>
                                        <td class="actual-score ${isZero(score2_2) ? 'zero' : ''}">${score2_2 || '0'}</td>
                                        <td class="result-value"></td>
                                        <td class="unit-value"></td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 2.2.1 -->
                                    <tr class="sub-sub-criteria">
                                        <td>2.2.1 ทุนสำรองสุทธิ (Net Working Capital) ≥0</td>
                                        <td class="full-score">1.0</td>

                                        <td class="actual-score ${isZero(P_nwc) ? 'zero' : ''}">${P_nwc || '0'}</td>
                                        
                                        <td class="result-value ${isZero(P_nwc) ? 'zero' : ''}">${formatNumber(nwc)}</td>
                                        <td class="unit-value">บาท</td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                    
                                    <!-- 2.2.2 -->
                                    <tr class="sub-sub-criteria">
                                        <td>2.2.2 Cash Ratio ≥0.8</td>
                                        <td class="full-score">1.0</td>
                                        <td class="actual-score ${isZero(getValue(row, headers, 'Cash')) ? 'zero' : ''}">${getValue(row, headers, 'Cash') || '0'}</td>
                                        <td class="result-value ${isZero(getValue(row, headers, 'Cash')) ? 'zero' : ''}">${formatNumber(cashRatio)}</td>
                                        <td class="unit-value">เท่า</td>
                                        <td class="group-value"></td>
                                        <td class="diff-value"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 8px; font-size: 0.8em; color: #7f8c8d; text-align: right;">
                            แหล่งข้อมูลจาก cmi@moph กบรส. ณ 28/10/2568
                        </div>

                        <!-- ส่วนปุ่มวิเคราะห์ -->
                        <!-- ส่วนปุ่มวิเคราะห์ -->
                        <div class="analysis-container">
                            <div></div> <!-- Spacer for Grid layout -->
                            
                            <div style="text-align: center;">
                                <button id="analyzeBtn" onclick="analyzeAndDisplay()" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); padding: 12px 30px; font-size: 1.1em; box-shadow: 0 4px 15px rgba(230, 126, 34, 0.4);">
                                    <span style="margin-right: 8px;">📊</span> วิเคราะห์ข้อมูลและแนวทางแก้ไข
                                </button>
                            </div>

                            <div style="display: flex; align-items: center; justify-content: flex-end; gap: 10px;">
                                <img src="https://drive.google.com/thumbnail?id=1CjyWLSfxjBZSlRSu4TzioHRVYX-PRMkO" 
                                     style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.1);" 
                                     alt="ดร.นพ.ชุมพล นุชผ่อง">
                                <div style="font-size: 0.85em; color: #7f8c8d; text-align: left; line-height: 1.3;">
                                    <strong>ดร.นพ.ชุมพล นุชผ่อง</strong><br>
                                    ผู้พัฒนาและออกแบบแนวทางแก้ไข
                                </div>
                            </div>
                        </div>

                        <!-- ส่วนแสดงผลการวิเคราะห์ -->
                        <div id="analysisSection" style="margin-top: 30px; display: none; border-top: 2px dashed #bdc3c7; padding-top: 25px;">
                            <h3 style="color: #2c3e50; margin-bottom: 20px; border-left: 5px solid #e67e22; padding-left: 15px;">
                                ผลการวิเคราะห์และแนวทางแก้ไข (รายการที่ได้ 0 คะแนน)
                            </h3>
                            <div class="table-container">
                                <table class="criteria-table" id="analysisTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%; background: #e67e22;">รายการ</th>
                                            <th style="width: 5%; background: #e67e22;">ผล</th>
                                            <th style="width: 10%; background: #e67e22;">เกณฑ์</th>
                                            <th style="width: 60%; background: #e67e22;">แนวทางแก้ไข</th>
                                            <th style="width: 10%; background: #e67e22;">ผู้รับผิดชอบ</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            resultsDiv.innerHTML = hospitalCard;
            resultsDiv.innerHTML = hospitalCard;
            // createRadarChart(row, headers); // Removed
        }

        // ฟังก์ชันแสดงผลการค้นหาทั้งหมด
        function displaySearchResults(results, query) {
            const resultsDiv = document.getElementById('results');

            if (!results || results.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>ไม่พบข้อมูลโรงพยาบาลที่ค้นหา</h3>
                        <p>คำค้นหา: "${query}"</p>
                        <p>กรุณาลองค้นหาใหม่ด้วยคำอื่น</p>
                    </div>
                `;
                return;
            }

            let resultsHTML = `
                <div class="search-results">
                    <div class="result-count">
                        พบ ${results.length} รายการสำหรับคำค้นหา: "${query}"
                    </div>
            `;

            results.forEach((result, index) => {
                resultsHTML += `
                    <div class="result-item" onclick="selectSearchResult(${result.index})">
                        <div class="result-name">${result.name}</div>
                        <div class="result-details">
                            รหัส: ${result.code} • จังหวัด: ${result.province} • เขต: ${result.district} • 
                            ระดับ: ${result.row[7] || 'N/A'} • 
                            <span style="color: #3498db;">ความคล้าย: ${Math.round(result.score * 100)}%</span>
                        </div>
                    </div>
                `;
            });

            resultsHTML += `</div>`;
            resultsDiv.innerHTML = resultsHTML;
        }

        // ฟังก์ชันเลือกผลการค้นหา
        function selectSearchResult(index) {
            const selectedHospital = {
                headers: window.hospitalData.main[0],
                row: window.hospitalData.main[index],
                index: index
            };
            displayHospitalData(selectedHospital);
        }

        // Radar Chart function removed

        // ฟังก์ชันแสดง/ซ่อน loading
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').innerHTML = '';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // ฟังก์ชันดึงข้อมูลวิเคราะห์
        async function fetchAnalysisData() {
            return new Promise((resolve, reject) => {
                const callbackName = 'analysisDataCallback_' + Date.now();
                window[callbackName] = function (data) {
                    delete window[callbackName];
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                    if (data.error) {
                        reject(new Error(data.message));
                    } else {
                        resolve(data.list || []);
                    }
                };

                const script = document.createElement('script');
                script.src = `https://script.google.com/macros/s/AKfycbyO26iU11w8EnwnWIz3d1S5uEYmBbUrzIgK3PXooMajmblDAppEuPAqsykGN7XY8uFB/exec?action=analysis&callback=${callbackName}`;

                script.onerror = function () {
                    delete window[callbackName];
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                    reject(new Error('ไม่สามารถโหลดข้อมูลวิเคราะห์ได้'));
                };

                document.head.appendChild(script);
            });
        }

        // ฟังก์ชันวิเคราะห์และแสดงผล
        async function analyzeAndDisplay() {
            const btn = document.getElementById('analyzeBtn');
            const container = document.getElementById('analysisSection');
            const tbody = document.querySelector('#analysisTable tbody');

            if (!btn || !container || !tbody) return;

            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width: 20px; height: 20px; border-width: 2px; display: inline-block; vertical-align: middle; margin-right: 10px;"></span> กำลังวิเคราะห์...';

            try {
                // 1. ดึงข้อมูลวิเคราะห์จาก Server
                const analysisList = await fetchAnalysisData();

                // 2. หาข้อที่ได้ 0 คะแนนจากตารางหลัก
                const zeroItems = [];
                // เลือกเฉพาะแถวที่มีคะแนนเป็น 0 (class actual-score zero)
                const zeroScoreCells = document.querySelectorAll('.criteria-table .actual-score.zero');

                zeroScoreCells.forEach(cell => {
                    const row = cell.closest('tr');
                    if (row) {
                        // หาชื่อรายการ (Cell แรก)
                        const nameCell = row.querySelector('td:first-child');
                        // หาค่าผลลัพธ์ (Cell result-value)
                        const resultCell = row.querySelector('.result-value');

                        if (nameCell) {
                            let name = nameCell.textContent.trim();
                            // Clean up name (remove extra spaces)
                            name = name.replace(/\s+/g, ' ');

                            let resultValue = resultCell ? resultCell.textContent.trim() : '-';

                            zeroItems.push({
                                name: name,
                                result: resultValue,
                                element: row
                            });
                        }
                    }
                });

                // 3. จับคู่และสร้างตาราง
                tbody.innerHTML = '';
                let count = 0;

                // ใช้ Set เพื่อป้องกันรายการซ้ำ
                const processedNames = new Set();

                zeroItems.forEach(item => {
                    if (processedNames.has(item.name)) return;

                    // หาข้อมูลใน analysisList ที่ชื่อตรงกัน
                    // ใช้การเปรียบเทียบแบบตัดช่องว่างและตัวอักษรพิเศษออกบางส่วนเพื่อให้แม่นยำขึ้น
                    const match = analysisList.find(a => {
                        if (!a.name) return false;
                        const cleanItemName = item.name;
                        const cleanAnalysisName = a.name.toString().trim().replace(/\s+/g, ' ');

                        // เปรียบเทียบชื่อเต็ม หรือ ชื่อที่มีอยู่ในกันและกัน
                        return cleanItemName === cleanAnalysisName ||
                            cleanItemName.includes(cleanAnalysisName) ||
                            cleanAnalysisName.includes(cleanItemName);
                    });

                    if (match) {
                        // ตรวจสอบว่ามีข้อมูลแนวทางแก้ไขหรือไม่
                        if (!match.solution || match.solution.toString().trim() === '') {
                            return; // ข้ามรายการนี้ถ้าไม่มีแนวทางแก้ไข
                        }

                        count++;
                        processedNames.add(item.name);

                        // จัดรูปแบบข้อความให้เว้นบรรทัดเหมือนใน Sheet
                        const formatText = (text) => {
                            if (!text) return '-';
                            return text.toString().replace(/\n/g, '<br>');
                        };

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td style="font-weight: 500;">${item.name}</td>
                            <td style="text-align: center; color: #e74c3c; font-weight: bold;">${item.result}</td>
                            <td>${match.criteria || '-'}</td>
                            <td style="text-align: left;">${formatText(match.solution)}</td>
                            <td style="text-align: center;">${match.responsible || '-'}</td>
                        `;
                        tbody.appendChild(tr);
                    }
                });

                if (count === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 30px; color: #7f8c8d;">ไม่พบรายการที่ต้องแก้ไข (หรือไม่มีข้อมูลวิเคราะห์ที่ตรงกัน)</td></tr>`;
                }

                container.style.display = 'block';
                // เลื่อนหน้าจอลงมาที่ตารางวิเคราะห์
                setTimeout(() => {
                    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);

            } catch (error) {
                console.error(error);
                alert('เกิดข้อผิดพลาด: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ฟังก์ชันเริ่มต้นแอปพลิเคชัน
        // ฟังก์ชันเริ่มต้นแอปพลิเคชัน
        async function initApp() {
            try {
                await fetchHospitalList();

                // Event Listener สำหรับช่องค้นหา
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    showSuggestions(query);
                });

                // ซ่อน dropdown เมื่อคลิกพื้นที่อื่น
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.search-box')) {
                        document.getElementById('suggestions').style.display = 'none';
                    }
                });

                // ปุ่มแสดงข้อมูลทั้งหมด removed



                // ปุ่ม Enter
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const query = e.target.value.trim();
                        showSuggestions(query);
                    }
                });

            } catch (error) {
                console.error(error);
                document.getElementById('results').innerHTML = `
                    <div class="error">
                        <h3>เกิดข้อผิดพลาดในการเริ่มต้นระบบ</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 10px; font-size: 0.9em;">
                            กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต
                        </p>
                    </div>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>
