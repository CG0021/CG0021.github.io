<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI TPS Analyzer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            padding: 2rem;
            background-color: #f0f8ff;
        }
        .container-fluid {
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #loading, #aiLoading {
            display: none;
        }
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            border: 1px solid rgba(0,0,0,.15);
            border-top: none;
            max-height: 300px;
            overflow-y: auto;
            background-color: #fff;
        }
        .autocomplete-item {
            padding: .5rem 1rem;
            background-color: #fff;
            cursor: pointer;
        }
        .autocomplete-item:hover {
            background-color: #e9ecef;
        }

        /* Table styles */
        .result-table th, .result-table td {
            text-align: right;
            padding: 8px;
        }
        .result-table th:first-child, .result-table td:first-child {
            text-align: left;
            font-weight: bold;
        }
        .negative-value {
            color: red !important;
        }

        /* --- Custom Styles (Similar to tps.html for consistency) --- */
        .main-header-bg { background-color: #d1d5db !important; font-weight: bold; }
        .subheader-level-2 { background-color: #e9ecef !important; font-weight: 500; }
        .subheader-level-3 { background-color: #f3f4f6 !important; }
        .subheader-level-4 { background-color: #ffffff !important; }
        .table-info { background-color: #cff4fc !important; font-weight: bold; }
        .performance-table th { text-align: center; }
        .performance-table th:first-child { text-align: left; }
        
        /* AI Panel styles */
        #aiAnalysisResult {
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 1.5rem;
            background-color: #eaf6ff;
        }
        .ai-section h4 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.5rem;
            margin-top: 1rem;
        }
        .grade-a { background-color: #198754; color: white; font-weight: bold; }
        .grade-b { background-color: #ffc107; color: black; font-weight: bold; }
        .grade-c { background-color: #fd7e14; color: white; font-weight: bold; }
        .grade-d { background-color: #dc3545; color: white; font-weight: bold; }
        .grade-e { background-color: #791a8b; color: white; font-weight: bold; }
        .grade-f { background-color: #000000; color: white; font-weight: bold; }
        .grade-na { background-color: #6c757d; color: white; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>ü§ñ AI TPS Analyzer</h1>
            <a href="tps.html" class="btn btn-secondary btn-lg">¬´ ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</a>
        </div>
        
        <div class="alert alert-info" role="alert">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• 1 ‡πÅ‡∏´‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÇ‡∏î‡∏¢ AI
        </div>

        <div class="autocomplete-container">
            <div class="input-group mb-3">
                <input type="text" id="codeInput" class="form-control" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•..." autocomplete="off">
            </div>
            <div id="autocompleteResults" class="autocomplete-results list-group"></div>
        </div>

        <div id="loading" class="text-center my-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
        </div>
        
        <div id="hospitalInfo" class="mt-4 text-center" style="display:none;">
            <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•: <span id="hospitalNameDisplay"></span></h3>
        </div>

        <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
        <h2 id="result-header" class="mt-4 mb-3 text-center" style="display:none;">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á</h2>
        <div id="result" class="table-responsive"></div>
        
        <h2 id="performance-header" class="mt-5 mb-3 text-center" style="display:none;">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</h2>
        <div id="performance-result" class="table-responsive"></div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå AI -->
        <h2 id="ai-header" class="mt-5 mb-3 text-center" style="display:none;">üß† ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÇ‡∏î‡∏¢ AI</h2>
        <div id="aiAnalysisResult" style="display:none;">
            <div id="aiLoading" class="text-center my-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
            </div>
            <div id="aiContent"></div>
        </div>
    </div>

    <script>
        // üö® ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: URL ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (Apps Script Web App)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwamKnJ0EhYybZT1LwldSUXW8Kq75JS62HinmjucgH-wFqbjnjRy61Fcel9nH91khcw/exec'; 
        // üö® API Key ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Gemini - ‡∏´‡∏≤‡∏Å‡∏£‡∏±‡∏ô‡πÉ‡∏ô Canvas ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        const GEMINI_API_KEY = "";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
        
        const codeInput = document.getElementById('codeInput');
        const resultDiv = document.getElementById('result');
        const performanceResultDiv = document.getElementById('performance-result');
        const loadingDiv = document.getElementById('loading');
        const aiLoadingDiv = document.getElementById('aiLoading');
        const aiContentDiv = document.getElementById('aiContent');
        const hospitalNameDisplay = document.getElementById('hospitalNameDisplay');
        const aiAnalysisResultDiv = document.getElementById('aiAnalysisResult');

        let allHospitals = [];
        let hospitalData = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        let tpsCriteria = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πåTPS'
        
        // --- MAP DATA: ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà 1 (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á) ---
        const comparisonDataMap = [
            { 
                section: '1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á ‡∏ì ‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™',
                items: [
                    { label: '1.1 Risk score', key: 'RiskScore', isNumeric: false },
                    { label: '1.2 ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (NWC)', key: '‡∏ó‡∏∏‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏™‡∏∏‡∏ó‡∏ò‡∏¥(NWC)', isNumeric: true },
                    { label: '1.3 ‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', key: '‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', isNumeric: true },
                    { label: '1.4 ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏á‡∏ö‡∏•‡∏á‡∏ó‡∏∏‡∏ô) ‡∏´‡∏±‡∏Å ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢) EBITDA', key: 'EBITDA', isNumeric: true },
                    { label: '1.5 ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á (‡∏ï‡πà‡∏≥) ‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (NI)', key: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏á (‡∏ï‡πà‡∏≥)‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (NI)', isNumeric: true }
                ]
            },
            {
                section: '2. ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û ‡∏ì ‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™',
                items: [
                    { label: '‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å 15 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô', key: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û', isNumeric: true, format: '1-decimal', isBold: true },
                    { label: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô', key: 'TPS Grade', isNumeric: false, isGrade: true, isBold: true } 
                ]
            }
        ];
        // --- END MAP DATA ---

        // Map ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà 2)
        const performanceDataMap = [
            { label: '‡∏£‡∏ß‡∏°', fullScore: 15, key: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û', isNumeric: true, isBold: true, level: 0, indent: 0 },
            { label: '1. ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£ (Process Indicators)', isHeader: true, level: 1, fullScore: null, indent: 0 },
            { label: '1.1 ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á', fullScore: '2.0', key: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 1.1', isNumeric: true, indent: 1, level: 2 },
            { label: '1.1.1 ‡∏°‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ¬†¬± ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 %', fullScore: '1.0', key: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ', isNumeric: true, indent: 2, level: 3 },
            { label: '1.1.2 ‡∏°‡∏¥‡∏ï‡∏¥‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ¬†¬± ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 %', fullScore: '1.0', key: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', isNumeric: true, indent: 2, level: 3 },
            { label: '1.2 ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô', fullScore: '3.0', key: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô1.2', isNumeric: true, indent: 1, level: 2 },
            { label: '1.2.1 ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏¢‡∏≤&‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏°‡∏¥‡πÉ‡∏ä‡πà‡∏¢‡∏≤ ‚â§ 90 ‡∏ß‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‚â§ 180', fullScore: '1.0', key: 'P_App-D', isNumeric: true, indent: 2, level: 3 },
            { label: '1.2.2 ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏±‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥ UC ‚â§60 ‡∏ß‡∏±‡∏ô', fullScore: '0.5', key: 'P_acp uc', isNumeric: true, indent: 2, level: 3 },
            { label: '1.2.3 ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏±‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ‚â§60 ‡∏ß‡∏±‡∏ô', fullScore: '0.5', key: 'P_7plus', isNumeric: true, indent: 2, level: 3 },
            { label: '1.2.4 ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á (Inventory Management) ‚â§ 60 ‡∏ß‡∏±‡∏ô ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô ‡∏£‡∏û.‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏≤‡∏∞ ‚â§ 90 ‡∏ß‡∏±‡∏ô', fullScore: '1.0', key: 'P_Aip', isNumeric: true, indent: 2, level: 3 },
            { label: '1.3 ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£', fullScore: '5.0', key: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 1.3', isNumeric: true, indent: 1, level: 2 },
            { label: '1.3.1 ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', fullScore: '2.0', key: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 1.3.1', isNumeric: true, indent: 2, level: 3 },
            { label: '1.3.1.1 Unit Cost for OP', fullScore: '1.0', key: 'QM-OP', isNumeric: true, indent: 3, level: 4 },
            { label: '1.3.1.2 Unit Cost for IP', fullScore: '1.0', key: 'QM-IP', isNumeric: true, indent: 3, level: 4 },
            { label: '1.3.1.3 LC ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£', fullScore: '0.5', key: 'LC', isNumeric: true, indent: 3, level: 4 },
            { label: '1.3.1.4 MC ‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤', fullScore: '0.5', key: '‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤', isNumeric: true, indent: 3, level: 4 },
            { label: '1.3.1.5 MC ‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå', fullScore: '0.5', key: '‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå', isNumeric: true, indent: 3, level: 4 },
            { label: '1.3.1.6 MC ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏°‡∏¥‡πÉ‡∏ä‡πà‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå', fullScore: '0.5', key: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏°‡∏¥‡πÉ‡∏ä‡πà‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå', isNumeric: true, indent: 3, level: 4 },
            { label: '1.3.2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏á‡∏ö‡∏ó‡∏î‡∏•‡∏≠‡∏á‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', fullScore: '1.0', key: '1.3.2 ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏á‡∏ö‡∏ó‡∏î‡∏•‡∏≠‡∏á', isNumeric: true, indent: 2, level: 3 },
            { label: '1.3.3 ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï (Productivity) ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö', fullScore: '2.0', key: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 1.3.3', isNumeric: true, indent: 2, level: 3 },
            { label: '1.3.3.1 ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô ‚â• 80 %', fullScore: '1.0', key: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡πÄ‡∏ï‡∏µ‡∏¢‡∏á', isNumeric: true, indent: 3, level: 4 },
            { label: '1.3.3.2 SumAdjRW ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏£‡∏û. ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 5 %', fullScore: '1.0', key: 'Sum AdjRW', isNumeric: true, indent: 3, level: 4 },
            { label: '(‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å cmi@moph ‡∏Å‡∏ö‡∏£‡∏™. ‡∏ì 28/10/2568)', isFooter: true },
            { label: '2. ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ó‡πå‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô', isHeader: true, level: 1, fullScore: null, indent: 0 },
            { label: '2.1 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Å‡∏≥‡πÑ‡∏£', fullScore: '3.0', key: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 2.1', isNumeric: true, indent: 1, level: 2 },
            { label: '2.1.1 ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô (Operating Margin)', fullScore: '1.0', key: 'OPM', isNumeric: true, indent: 2, level: 3 },
            { label: '2.1.2 ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå (Return on Asset)', fullScore: '1.0', key: 'ROA', isNumeric: true, indent: 2, level: 3 },
            { label: '2.1.3 ‡∏ú‡∏•‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏° (EBITDA) ‚â•0', fullScore: '1.0', key: 'EBITDA_Score', isNumeric: true, indent: 2, level: 3 }, 
            { label: '2.2 ‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô', fullScore: '2.0', key: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 2.2', isNumeric: true, indent: 1, level: 2 },
            { label: '2.2.1 ‡∏ó‡∏∏‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net Working Capital) ‚â•0', fullScore: '1.0', key: 'NWC_Score', isNumeric: true, indent: 2, level: 3 }, 
            { label: '2.2.2 Cash Ratio ‚â•0.8', fullScore: '1.0', key: 'Cash', isNumeric: true, indent: 2, level: 3 }
        ];

        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchAllHospitalsData(); 
            fetchTpsCriteria(); // ‡∏î‡∏∂‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå AI
        });
        
        // **‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Autocomplete ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß Trigger ‡∏´‡∏•‡∏±‡∏Å**
        codeInput.addEventListener('input', handleAutocompleteInput);
        
        // --- Core Functions ---
        
        async function safeFetchData(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${response.status} ${response.statusText}`);
            }
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
                return response.json();
            }
            const text = await response.text();
            console.error('Expected JSON but received:', text);
            throw new Error(`‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON)`);
        }

        async function fetchAllHospitalsData() {
            try {
                const res = await safeFetchData(`${SCRIPT_URL}?action=getAllHospitals`);
                if (res.status === 'success' && res.data.length > 0) {
                    allHospitals = res.data.map(h => ({
                        '‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•': h['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•'],
                        '‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•': h['‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•']
                    }));
                } else {
                    console.warn('Could not fetch all hospital data for autocomplete.');
                }
            } catch (error) {
                console.error('Error fetching all hospitals:', error);
            }
        }
        
        async function fetchTpsCriteria() {
            try {
                // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° Endpoint ‡πÉ‡∏ô Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πåTPS'
                const res = await safeFetchData(`${SCRIPT_URL}?action=getTpsCriteria`);
                
                if (res.status === 'success' && res.data.length > 0) {
                    tpsCriteria = res.data;
                    console.log('TPS Criteria Loaded:', tpsCriteria.length, 'items');
                } else {
                    console.warn('Could not fetch TPS Analysis Criteria.');
                }
            } catch (error) {
                console.error('Error fetching TPS Criteria:', error);
            }
        }

        /**
         * üéØ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå AI
         * @param {string} code - ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•
         */
        async function fetchAndAnalyzeHospital(code) {
            if (!code) return;

            hospitalData = null; // Clear previous data
            loadingDiv.style.display = 'block';
            aiAnalysisResultDiv.style.display = 'none';
            aiContentDiv.innerHTML = '';
            hospitalNameDisplay.textContent = '...';

            try {
                const res = await safeFetchData(`${SCRIPT_URL}?codes=${encodeURIComponent(code)}`);

                if (res.status === 'success' && res.data.length > 0) {
                    hospitalData = res.data[0];
                    hospitalNameDisplay.textContent = hospitalData['‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•'];
                    document.getElementById('hospitalInfo').style.display = 'block';
                    
                    // 1. ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                    renderAllTables(hospitalData);
                    
                    // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI Analysis
                    await analyzeWithAI(hospitalData);
                    
                } else {
                    alert(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™: ${code}`);
                }
            } catch (error) {
                console.error('Error fetching/analyzing hospital:', error);
                alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}.`);
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        /**
         * üß† ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Gemini API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
         * @param {Object} data - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
         */
        async function analyzeWithAI(data) {
            aiAnalysisResultDiv.style.display = 'block';
            aiLoadingDiv.style.display = 'block';
            aiContentDiv.innerHTML = '';

            try {
                // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt: ‡∏ú‡∏ô‡∏ß‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
                const hospitalName = data['‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•'];
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏Ç‡∏≠‡∏á ‡∏£‡∏û. (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ key ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
                let performanceMetrics = performanceDataMap.filter(item => item.key && item.key.includes('‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô')).map(item => ({
                    '‡πÄ‡∏Å‡∏ì‡∏ë‡πå': item.label,
                    '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ': data[item.key] || 'N/A',
                    '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°': item.fullScore
                }));
                
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå TPS ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
                let criteriaText = tpsCriteria.map(c => {
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ú‡πà‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏¢‡πà‡∏≠‡∏¢ ‡πÜ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£
                    let rawValue = data[c['‡∏£‡∏´‡∏±‡∏™ Key']]
                    if (rawValue === undefined) return null;

                    return `‡πÄ‡∏Å‡∏ì‡∏ë‡πå: ${c['‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û']} | ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ${rawValue} | ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ú‡πà‡∏≤‡∏ô: ${c['‡πÄ‡∏Å‡∏ì‡∏ë‡πå']} | ‡∏ú‡πà‡∏≤‡∏ô: ${c['‡∏ú‡πà‡∏≤‡∏ô']} | ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: ${c['‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô']} | ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô): ${c['‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å']} | ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ${c['‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç']} | ‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ${c['‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ']}`;
                }).filter(Boolean).join('\n---\n');


                const systemInstruction = "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Total Performance Score (TPS) ‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç ‡πÇ‡∏õ‡∏£‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û";

                const userQuery = `
                    ‡πÇ‡∏õ‡∏£‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏∑‡πà‡∏≠ "${hospitalName}" ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå TPS:
                    
                    --- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ${hospitalName} ---
                    - ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (Risk Score): ${data['RiskScore'] || 'N/A'}
                    - ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô TPS Grade: ${data['TPS Grade'] || 'N/A'}
                    - ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (NWC): ${new Intl.NumberFormat('th-TH').format(data['‡∏ó‡∏∏‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏™‡∏∏‡∏ó‡∏ò‡∏¥(NWC)'] || 0)}
                    - EBITDA: ${new Intl.NumberFormat('th-TH').format(data['EBITDA'] || 0)}
                    
                    --- ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô (Metrics) ---
                    ${performanceMetrics.map(m => `- ${m['‡πÄ‡∏Å‡∏ì‡∏ë‡πå']} (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° ${m['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°']}): ‡πÑ‡∏î‡πâ ${m['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ']}`).join('\n')}
                    
                    --- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏Å‡∏ì‡∏ë‡πå TPS (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞) ---
                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥):
                    ${criteriaText}

                    --- ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ---
                    ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏õ‡πá‡∏ô 3 ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
                    1. **‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á:** ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (Risk Score, NWC, EBITDA) ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á (‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏µ)
                    2. **‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á:** ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏î‡∏µ (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô' ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå) ‡πÅ‡∏•‡∏∞‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å' ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
                    3. **‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞:** ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ (Actionable Advice) ‡∏ï‡∏≤‡∏° '‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' ‡πÅ‡∏•‡∏∞ '‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ' ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå ‡πÇ‡∏î‡∏¢‡πÄ‡∏ô‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤ '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô' ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
                    
                    ‡πÇ‡∏õ‡∏£‡∏î‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Markdown (‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠, ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
                `;
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemInstruction }] },
                };

                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Gemini API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    aiContentDiv.innerHTML = formatAIResponse(text);
                } else {
                    aiContentDiv.innerHTML = '<p class="text-danger">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å AI ‡πÑ‡∏î‡πâ (No content generated).</p>';
                }

            } catch (error) {
                console.error('Error during AI analysis:', error);
                aiContentDiv.innerHTML = `<p class="text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå: ${error.message}</p>`;
            } finally {
                aiLoadingDiv.style.display = 'none';
            }
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        function renderAllTables(data) {
            if (!data) return;

            const hospitalArray = [data]; // ‡∏™‡∏£‡πâ‡∏≤‡∏á Array ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
            
            // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà 1
            document.getElementById('result-header').style.display = 'block';
            displayComparisonTable(hospitalArray);

            // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà 2
            document.getElementById('performance-header').style.display = 'block';
            displayPerformanceTable(hospitalArray);
        }
        
        // --- Display Table Functions (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å tps.html) ---

        function displayComparisonTable(data) {
            // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà 1 (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö) - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
            let table = '<table class="table table-bordered table-striped result-table">';
            table += '<thead><tr><th class="bg-light">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="bg-light">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</th></tr></thead>';
            table += '<tbody>';
            comparisonDataMap.forEach(group => {
                table += `<tr><td colspan="2" class="main-header-bg text-start">${group.section}</td></tr>`;
                group.items.forEach(item => {
                    const style = item.isBold ? 'font-weight: bold;' : '';
                    table += `<tr><td style="${style}">${item.label}</td>`;
                    let value = (item.key && data[0][item.key] !== undefined) ? data[0][item.key] : 'N/A';
                    table += formatCell(value, item.isNumeric, item.key, item.isGrade, item.format);
                    table += '</tr>';
                });
            });
            table += '</tbody></table>';
            resultDiv.innerHTML = table;
        }

        function displayPerformanceTable(data) {
            // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà 2 (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û) - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
            let table = '<table class="table table-bordered table-striped result-table performance-table">';
            table += '<thead><tr><th class="bg-light" style="width: 70%;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="bg-light" style="width: 15%;">‡πÄ‡∏ï‡πá‡∏°</th><th class="bg-light" style="width: 15%;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr></thead>';
            table += '<tbody>';
            performanceDataMap.forEach(item => {
                let rowClass = '';
                if (item.isHeader) {
                    table += `<tr><td colspan="3" class="main-header-bg"><b>${item.label}</b></td></tr>`;
                    return;
                } else if (item.isFooter) {
                    table += `<tr><td colspan="3" class="text-center text-muted small"><i>${item.label}</i></td></tr>`;
                    return;
                }
                
                if (item.level === 0) { rowClass = 'table-info'; 
                } else if (item.level === 2) { rowClass = 'subheader-level-2'; 
                } else if (item.level === 3) { rowClass = 'subheader-level-3'; 
                } else if (item.level === 4) { rowClass = 'subheader-level-4'; }
                
                const labelStyle = `padding-left: ${ (item.indent || 0) * 20 + 10}px; ${item.isBold ? 'font-weight: bold;' : ''}`;
                
                table += `<tr class="${rowClass}">`;
                table += `<td style="${labelStyle}" class="text-start">${item.label}</td>`; 
                table += `<td class="text-center">${item.fullScore !== undefined && item.fullScore !== null ? item.fullScore : ''}</td>`;
                
                let value = (item.key && data[0][item.key] !== undefined) ? data[0][item.key] : 'N/A';
                table += formatCell(value, item.isNumeric, item.key, false, '1-decimal'); 
                
                table += `</tr>`;
            });
            table += '</tbody></table>';

            performanceResultDiv.innerHTML = table;
        }

        // --- Autocomplete Functions ---
        const autocompleteResultsDiv = document.getElementById('autocompleteResults');

        function handleAutocompleteInput() {
            const query = codeInput.value.trim();
            if (query.length < 2) { 
                clearAutocompleteResults();
                return;
            }

            const filteredHospitals = allHospitals.filter(hospital => 
                hospital['‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•'].toLowerCase().includes(query.toLowerCase()) ||
                String(hospital['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•']).includes(query)
            ).slice(0, 10); 

            displayAutocompleteResults(filteredHospitals);
        }

        function displayAutocompleteResults(hospitals) {
            clearAutocompleteResults();
            if (hospitals.length === 0) {
                return;
            }

            hospitals.forEach(hospital => {
                const item = document.createElement('div');
                item.classList.add('autocomplete-item', 'list-group-item');
                item.textContent = `${hospital['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•']} - ${hospital['‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•']}`;
                item.dataset.hospitalId = hospital['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•'];
                item.addEventListener('click', selectAutocompleteItem);
                autocompleteResultsDiv.appendChild(item);
            });
            autocompleteResultsDiv.style.display = 'block';
        }

        function selectAutocompleteItem(event) {
            const selectedId = event.target.dataset.hospitalId;
            fetchAndAnalyzeHospital(selectedId); 
            clearAutocompleteResults();
            codeInput.value = event.target.textContent; // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        }

        function clearAutocompleteResults() {
            autocompleteResultsDiv.innerHTML = '';
            autocompleteResultsDiv.style.display = 'none';
        }
        
        // --- Formatting and Utility (‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å tps.html) ---

        const SCORE_KEYS_ONE_DECIMAL = [
            '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û', '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 1.1', '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ', '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô1.2', 'P_App-D', 'P_acp uc', 'P_7plus', 'P_Aip',
            'EBITDA_Score', 'NWC_Score', 'CashRatio_Score',
            '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 1.3', '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 1.3.1', 'QM-OP', 'QM-IP', 'LC', '‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤', '‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå',
            '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏°‡∏¥‡πÉ‡∏ä‡πà‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå', '1.3.2 ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏á‡∏ö‡∏ó‡∏î‡∏•‡∏≠‡∏á', '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 1.3.3', '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡πÄ‡∏ï‡∏µ‡∏¢‡∏á',
            'Sum AdjRW', '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 2.1', 'OPM', 'ROA', 'EBITDA_Score', '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 2.2', 'NWC_Score', 'Cash'
        ];
        
        function getGradeClass(grade) {
            const normalizedGrade = String(grade).toUpperCase().trim();
            switch (normalizedGrade) {
                case 'A': return 'grade-a';
                case 'B': return 'grade-b';
                case 'C': return 'grade-c';
                case 'D': return 'grade-d';
                case 'E': return 'grade-e';
                case 'F': return 'grade-f';
                default: return 'grade-na';
            }
        }
        
        function getRiskScoreColor(score) {
            const value = parseFloat(score);
            if (isNaN(value)) return '#FFFFFF';
            const clampedScore = Math.max(0, Math.min(7, value));
            let red, green;
            if (clampedScore <= 3.5) {
                red = Math.round(255 * (clampedScore / 3.5));
                green = 255;
            } else {
                red = 255;
                green = Math.round(255 * (1 - (clampedScore - 3.5) / 3.5));
            }
            return `rgb(${red}, ${green}, 0)`;
        }

        function formatCell(value, isNumeric, itemKey = '', isGrade = false, format = '2-decimal') {
            let style = '';
            let cellValue = value;
            let cssClass = '';
            
            if (value === 'N/A' || value === null || value === undefined || value === '') {
                cellValue = 'N/A';
                cssClass = 'text-muted';
                return `<td class="${cssClass}" ${style}>${cellValue}</td>`;
            }

            if (isGrade) {
                cssClass = getGradeClass(value);
                cellValue = String(value).toUpperCase().trim();
                return `<td class="${cssClass} text-center" ${style}>${cellValue}</td>`;
            }

            if (itemKey === 'RiskScore') {
                const scoreValue = parseFloat(value);
                if (!isNaN(scoreValue)) {
                    style = `style="background-color: ${getRiskScoreColor(scoreValue)}; color: ${scoreValue > 2.5 && scoreValue < 5 ? 'black' : 'white'};"`;
                    cellValue = scoreValue.toFixed(1);
                }
            }

            if (isNumeric) {
                let numericValue = parseFloat(String(value).replace(/,/g, ''));
                if (!isNaN(numericValue)) {
                    let isZeroOrNegative = (numericValue < 0.0);
                    
                    let options = { minimumFractionDigits: 2, maximumFractionDigits: 2 };
                    
                    if (format === '1-decimal' || SCORE_KEYS_ONE_DECIMAL.includes(itemKey)) {
                        options = { minimumFractionDigits: 1, maximumFractionDigits: 1 };
                    }
                    
                    cellValue = new Intl.NumberFormat('th-TH', options).format(numericValue);
                    
                    if (numericValue <= 0.0 && numericValue != 'N/A') { 
                        isZeroOrNegative = true;
                        if (numericValue == 0) cellValue = new Intl.NumberFormat('th-TH', options).format(0);
                    }
                    
                    if (isZeroOrNegative) {
                        cssClass = 'negative-value';
                    }

                } else {
                    cellValue = 'N/A';
                    cssClass = 'text-muted';
                }
            }
            
            return `<td class="${cssClass}" ${style}>${cellValue}</td>`;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á Markdown ‡πÄ‡∏õ‡πá‡∏ô HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• AI
        function formatAIResponse(markdownText) {
            // Very basic markdown to HTML conversion for display
            let html = markdownText.replace(/### (.*)/g, '<div class="ai-section"><h4>$1</h4></div>');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/^- (.*)/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            html = html.replace(/\n/g, '<br>');
            return html;
        }

    </script>

</body>
</html>
